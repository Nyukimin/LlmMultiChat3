# 会話履歴: 3D可視化パネル追加 (2025-11-11)

## ユーザーの要求

> "あと、一番大事なのが、ワード間の距離。近いモノをよく思い出して、遠いものはあまりリンクしない、みたいなやつ。スター型で３D図とかでるやつ。欲しい"
> "３D可視化はパネルのON/OFFで出したい。仕様に追加して"
> "ドキュメントに書き留めて"

## 実施した作業

### 1. 仕様書への追加 ([`docks/会話LLM_仕様.md`](会話LLM_仕様.md))

**セクション4.4.5「連想ネットワーク3D可視化」を追加**

#### 主な機能

1. **ON/OFF切り替え**
   - `AssociationVisualizationPanel.toggle()` メソッド
   - デフォルト: OFF（パフォーマンス優先）

2. **インタラクティブ操作**
   - マウスドラッグ: 回転
   - ホイール: ズーム
   - ノードクリック: 中心概念変更

3. **リアルタイム更新**
   - 会話トピックに応じて自動更新
   - 更新間隔: 1秒（configurable）

4. **可視化の特徴**
   - **ノードサイズ**: 中心からの距離（近いほど大きい）
   - **ノード色**: 距離別グラデーション（赤→オレンジ→黄→緑）
   - **エッジ太さ**: 関連性強度（0.0-1.0）
   - **エッジ色**: 強度別（赤→オレンジ→グレー）

5. **コントロールパネル**
   - 探索深度スライダー（1-5ホップ）
   - 関連性閾値（0.0-1.0）
   - レイアウト選択（力学モデル/階層/円形）

6. **エクスポート機能**
   - PNG形式（1920x1080）
   - HTML形式（インタラクティブ保持）

#### 実装クラス

```python
class AssociationVisualizationPanel:
    """連想ネットワーク3D可視化パネル（ON/OFF切り替え可能）"""
    
    def __init__(self, association_memory: AssociationMemory):
        self.association = association_memory
        self.is_visible = False  # デフォルトOFF
        self.fig = None
        self.auto_update = False
        
    def toggle(self) -> bool:
        """表示/非表示の切り替え"""
        self.is_visible = not self.is_visible
        return self.is_visible
        
    def update_center(self, concept: str, max_depth: int = 3):
        """中心概念を変更してグラフを更新"""
        if not self.is_visible:
            return
            
        # 連想ネットワークから関連概念を取得
        related = self.association.explore_associations(
            concept, max_depth=max_depth
        )
        
        # 3Dグラフを描画（Plotly + NetworkX）
        self.fig = self._create_3d_graph(concept, related)
        
    def export(self, filepath: str, format: str = "png"):
        """グラフをエクスポート"""
        if format == "png":
            self.fig.write_image(filepath, width=1920, height=1080)
        elif format == "html":
            self.fig.write_html(filepath)
```

#### パフォーマンス仕様

- 最大ノード数: 50（パフォーマンス考慮）
- 更新頻度: 1秒/回
- WebGL高速描画
- CPU負荷: 最小限

#### 使用例

```python
# 初期化
viz = AssociationVisualizationPanel(association_memory)

# ON/OFF切り替え
viz.toggle()  # True (表示)

# 会話中の自動更新
# ユーザー: 「インセプションについて話して」
viz.update_center("インセプション", max_depth=3)
# → 「夢」「記憶」「ノーラン」「時間」が近くに表示される

# エクスポート
viz.export("association_graph.png", format="png")
viz.export("association_graph.html", format="html")
```

## 技術的なポイント

1. **距離の計算**: 連想ネットワークのエッジ重み（0.0-1.0）を距離に変換
   - 距離 = 1.0 - 重み
   - 近い概念（重み高）= 距離小 = ノード大きい

2. **力学モデル**: NetworkXの`spring_layout`でノード配置
   - 関連性の強い概念ほど近くに配置
   - 視覚的に「よく思い出す」を表現

3. **スター型構造**: 中心概念を原点に、関連概念を放射状に配置
   - 深度1: 直接関連（最も近い）
   - 深度2-3: 間接関連（やや遠い）

4. **WebGL描画**: Plotlyの`plotly.graph_objects.Scatter3d`で高速描画

## ファイル更新状況

- ✅ [`docks/会話LLM_仕様.md`](会話LLM_仕様.md): セクション4.4.5追加完了
- ✅ [`docks/会話履歴_3D可視化パネル追加.md`](会話履歴_3D可視化パネル追加.md): この記録

## 次のステップ（実装フェーズ）

1. `core/memory/association_visualization.py` の実装
2. WebUIへの組み込み（Streamlit/FastAPI）
3. テストケースの作成

## 関連ファイル

- [`docks/会話LLM_仕様.md`](会話LLM_仕様.md): セクション4.4.5
- [`docks/会話LLM_実装仕様書.md`](会話LLM_実装仕様書.md): 実装詳細
- [`README.md`](../README.md): プロジェクト概要