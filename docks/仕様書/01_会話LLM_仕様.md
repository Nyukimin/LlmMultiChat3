# 会話LLM_仕様書.md
## ― 永続的記憶を持つマルチLLM会話システム 仕様書（拡張版） ―
（ルミナ／クラリス／ノクス＋拡張可能）

---

## 1. プロジェクト概要

**名称:** 会話LLM（Llm_Multi_Chat）
**目的:**
ローカル環境で複数のLLMが**永続的な記憶を持ちながら**連続して会話し、必要に応じて検索・推論・ユーザー割り込みを処理する
**拡張可能なマルチエージェント型会話フレームワーク**を構築する。

**特徴:**
- **複数LLMの同時動作**: 3キャラ（ルミナ／クラリス／ノクス）＋カスタムキャラの動的追加に対応
- **永続的記憶システム**: 短期・中期・長期記憶を階層化し、ユーザーとの会話履歴を永続保存
- **LangGraphによる状態遷移制御**: 複雑な会話フローを管理
- **プラグイン型アーキテクチャ**: 新しいLLMやツールを動的に追加可能
- **ローカル＋クラウドハイブリッド**: Ollama（ローカル）とAPI（Claude、GPT等）を併用可能
- **マルチモーダル対応**: テキスト・音声・画像入力に対応
- **セッション管理**: マルチユーザー・マルチセッションを同時並行処理

---

## 2. アーキテクチャ全体像（拡張版）

```
┌─────────────────────────────────────────────────────────────┐
│                    ユーザー入力層                              │
│  (テキスト / 音声 / 画像 / ファイル / コマンド)                    │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────────┐
│              入力処理・前処理層                                 │
│  - 音声→テキスト変換 (Whisper)                                 │
│  - 画像解析 (Vision API / OCR)                                │
│  - コマンド解析 (@指名, /command)                              │
│  - 意図分類 (Intent Classifier)                               │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────────┐
│            Router Node（コンテキスト認識・ルーティング）           │
│  - ユーザー指名判定 (@ルミナ, @all)                             │
│  - ドメイン適性スコア計算                                        │
│  - 記憶参照（過去の文脈・ユーザー嗜好）                            │
│  - 優先度スコアリング                                           │
│  - 並列/順次実行判定                                            │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
         ┌────────────┴────────────┐
         ↓                         ↓
┌──────────────────┐    ┌──────────────────┐
│  Character Pool   │    │  Tool Executor   │
│                   │    │  - Web検索        │
│  - ルミナ          │    │  - DB検索        │
│  - クラリス        │    │  - API呼び出し    │
│  - ノクス          │    │  - ファイル操作   │
│  - [カスタム1]     │    │  - コード実行     │
│  - [カスタム2]     │    │  - 計算処理       │
│  - ...            │    └──────────────────┘
└────────┬─────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│               LangGraph State Machine                         │
│  - 会話フロー制御                                               │
│  - 並列処理管理                                                │
│  - 条件分岐・ループ                                             │
│  - エラーハンドリング                                           │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────────┐
│                  階層型記憶システム                             │
│  - 短期記憶 (Working Memory)                                  │
│  - 中期記憶 (Session Memory)                                  │
│  - 長期記憶 (Persistent Memory)                               │
│  - 連想記憶 (Associative Memory)                              │
│  - 知識ベース (Knowledge Base - RAG層)                        │
│                                                               │
│  詳細は [会話LLM_記憶システム仕様.md](./02_会話LLM_記憶システム仕様.md) 参照 │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────────┐
│                  出力処理・後処理層                             │
│  - テキスト整形                                                │
│  - 音声合成 (TTS)                                             │
│  - 画像生成 (Stable Diffusion / DALL-E)                       │
│  - Markdown / HTML / JSON 変換                               │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
                  ユーザーへ出力
````

### 2.1 分割ファイル一覧

この仕様書は以下の5つの詳細仕様ファイルに分割されています:

| ファイル | 内容 | 行数 |
|---------|------|------|
| [会話LLM_記憶システム仕様.md](./02_会話LLM_記憶システム仕様.md) | 短期・中期・長期・連想・知識ベース記憶の詳細 | 約700行 |
| [会話LLM_キャラクター仕様.md](./03_会話LLM_キャラクター仕様.md) | 標準キャラ・カスタムキャラ・成長システム | 約400行 |
| [会話LLM_感情・対話仕様.md](./04_会話LLM_感情・対話仕様.md) | 感情モデル・対話スタイル・自己省察 | 約500行 |
| [会話LLM_連想記憶仕様.md](./05_会話LLM_連想記憶仕様.md) | 連想記憶・SQLite Graph実装・学習メカニズム | 約450行 |
| [会話LLM_3D可視化仕様.md](./06_会話LLM_3D可視化仕様.md) | 3D可視化パネル・Plotly.js実装 | 約350行 |

**合計:** 約2,900行（元ファイル拡張・整理版）

---

## 3. キャラクター仕様（概要）

### 3.1 標準キャラクター

| キャラ | 役割 | 個性・口調 | 検索 | ツール | 優先DB | モデル |
|--------|------|-------------|------|--------|--------|--------|
| **ルミナ** | 司会・雑談・推論 | フレンドリー／洞察型 | ✅ | Web検索, 画像生成 | MovieDB, HistoryDB | GPT-4o / Gemini |
| **クラリス** | 構造化・解説 | 穏やか／理論派 | ❌ | データ分析, グラフ生成 | HistoryDB | Claude Sonnet |
| **ノクス** | 情報ハンター・検証 | クール／要約特化 | ✅（高速） | リアルタイム検索, API | GossipDB, MovieDB | Llama3-JP |

### 3.2 カスタムキャラクター・成長システム

- **動的ロード**: `personas/*.yaml` から自動読み込み
- **KPIベース成長**: ユーザー評価、タスク成功率で自動進化
- **LoRAファインチューニング**: 会話パターン学習（月次バッチ処理）

**詳細:** [会話LLM_キャラクター仕様.md](./03_会話LLM_キャラクター仕様.md)

---

## 4. 永続的記憶アーキテクチャ（概要）

### 4.1 記憶階層

| レイヤー | 保存先 | TTL | 主目的 |
|-----------|--------|------|--------|
| **短期記憶** | LangGraph State (RAM) | 6〜12ターン | 文脈維持・即時応答 |
| **中期記憶** | SQLite (WAL mode) | 24h〜30d | セッション復帰・割込み対応 |
| **長期記憶** | SQLite FTS5 | 永続 | 継続学習・パーソナライズ |
| **連想記憶** | SQLite Graph (再帰CTE) | 永続 | 創造的発想・話題発展 |
| **知識ベース** | SQLite FTS5 + Faiss Lite | 定期更新 | RAG検索・事実参照 |

### 4.2 SQLite一本化の利点

✅ **ローカル完結**（オフライン動作）  
✅ **超軽量**（500MB以下）  
✅ **高速**（ほとんどの操作 < 20ms）  
✅ **セットアップ不要**（Python標準）  
✅ **バックアップ容易**（単一ファイル）

**詳細:** [会話LLM_記憶システム仕様.md](./02_会話LLM_記憶システム仕様.md)

---

## 5. スレッド構造と判定

| フェーズ | 条件 |
|-----------|------|
| **開始** | 初回入力／トピック変更／ドメイン変化／「ところで…」発言 |
| **終了** | 類似度 < 0.75／アイドル10分／ターン上限／話題転換 |
| **短期保持** | 最大12メッセージ（ユーザー＋3キャラ） |
| **flush処理** | summary＋keywords＋embeddingを生成し中期へ転送 |

---

## 6. 会話ルーティング仕様

### ルール優先順

1. **ユーザー指名**：@ルミナ,@ノクス
2. **ドメイン適性スコア**：`adapter_priority.yaml` ≥ 0.6
3. **ラウンドロビン＋クールタイム**：連投防止
4. **スムーズ補正**：前発話者との連続制御

**詳細:** [会話LLM_キャラクター仕様.md](./03_会話LLM_キャラクター仕様.md)

---

## 7. ユーザー沈黙時の自走

```
IdleWatcher(15s)
   ↓
AutoPromptGenerator（未完話題の深掘り・提案）
   ↓
Router Node
   ↓
Character Nodes
```

* 自動発話3回後：「続けますか？」を確認
* MaxTurns到達で要約→終了

---

## 8. 知識ベース（RAG層）- 概要

### 8.1 カテゴリ別独立DB（SQLite FTS5）

- **映像・演劇**: `kb:movie`, `kb:tv`, `kb:anime`, `kb:theater`
- **文学・コミック**: `kb:novel`, `kb:manga`, `kb:lightnovel`, `kb:poetry`
- **ゲーム**: `kb:videogame`, `kb:boardgame`, `kb:tabletop`
- **音楽**: `kb:music`, `kb:classical`, `kb:jpop`
- **一般**: `kb:history`, `kb:tech`, `kb:news`, `kb:gossip`, `kb:sports`, `kb:food`

### 8.2 クロスカテゴリ統合インデックス

- **作品マスター**: タイトル・多言語表記管理
- **メディアミックス関係**: 小説→漫画→アニメ→映画の系譜
- **高速検索**: インデックスのみ < 5ms、詳細読込 < 30ms

**詳細:** [会話LLM_記憶システム仕様.md](./02_会話LLM_記憶システム仕様.md)（セクション8）

---

## 9. KPIとキャラ成長

| KPI            | トリガー         |
| -------------- | ------------ |
| user_thumbs_up | ユーザー評価 👍    |
| answer_hits    | 推薦映画が再生リスト入り |
| search_success | ノクス検索結果が採用   |

計算式：

```python
level = floor(sqrt(total_kpi / 10))
```

成長結果：

* 会話スタイルや口調の自然変化
* 3Dアバター・衣装・声質更新
* KPI履歴はMetaDBに保存

**詳細:** [会話LLM_キャラクター仕様.md](./03_会話LLM_キャラクター仕様.md)（セクション3.3）

---

## 10. ストレージポリシー（A/B案）

| ポリシー          | 内容                   | 検索性   | ストレージ          |
| ------------- | -------------------- | ----- | -------------- |
| **A. 要約のみ永続** | VectorDBにsummaryのみ保存 | 高速    | 省容量・低負荷        |
| **B. フルログ保存** | S3/MinIOにParquetで保存  | 全文検索可 | コスト増・高セキュリティ要求 |

推奨：**A + LoRA（キャラ成長）併用構成**

---

## 11. セキュリティ・運用

| 項目     | 方針                                |
| ------ | --------------------------------- |
| 通信暗号化  | Redis→TLS、VectorDB→LUKS/KMS       |
| GDPR削除 | `DROP NAMESPACE user:<uid>` で完全削除 |
| バックアップ | Redis RDB 30分／DuckDB→MinIO日次      |
| 監査ログ   | `session_log` に追記オンリー記録           |

---

## 12. 開発ロードマップ（要約）

| フェーズ | 主要タスク                                  |
| ---- | -------------------------------------- |
| ① 基盤 | RouterNode／IdleWatcher／AutoPromptGen実装 |
| ② 機能 | Memory階層／ETL DAG／KPI→レベル化              |
| ③ UI | 3Dキャラ＋指名バッジ＋メモリビューア                    |
| ④ 成長 | LoRA適用・KPI連動チューニング                     |
| ⑤ 運用 | WebUI／マルチユーザー化／監視強化                    |

---

## 13. マルチセッション・マルチユーザー対応

- **asyncio**: 複数セッションの同時処理
- **LangGraph並列ノード**: 複数キャラの同時応答
- **Redis Pub/Sub**: セッション間通信

---

## 14. 拡張機能

### 14.1 プラグインシステム

- **新しいツールの追加**: `@register_tool` デコレータ
- **新しいキャラクター**: YAML設定から動的ロード

### 14.2 API連携

- **外部LLM**: OpenAI API、Anthropic API、Google AI
- **音声入出力**: Whisper (STT)、ElevenLabs (TTS)
- **画像生成**: Stable Diffusion、DALL-E

### 14.3 マルチモーダル

- **画像入力**: OCR、物体認識、顔認識
- **音声入力**: リアルタイム文字起こし
- **ファイル入力**: PDF、DOCX、CSV解析

---

## 15. セキュリティ・プライバシー

### 15.1 データ保護

| 項目     | 方針                                |
| ------ | --------------------------------- |
| 暗号化    | Redis→TLS、VectorDB→LUKS/KMS、通信HTTPS |
| アクセス制御 | JWT認証、Role-Based Access Control |
| データ削除  | `DROP NAMESPACE user:<uid>` で完全削除 |
| 匿名化    | 個人情報の自動マスキング |

### 15.2 GDPR対応

- **Right to Access**: ユーザーは自分の全データをエクスポート可能
- **Right to Erasure**: ワンコマンドで全記憶削除
- **Data Portability**: JSON/CSV形式でデータ移行

---

## 16. 開発ロードマップ（拡張版）

| フェーズ | 主要タスク                                  | 期間 |
| ---- | -------------------------------------- | ---- |
| **① 基盤構築** | RouterNode／Memory階層／LangGraph実装 | 1-2ヶ月 |
| **② コア機能** | 3キャラ実装／ETL Pipeline／検索統合 | 2-3ヶ月 |
| **③ 永続化** | VectorDB統合／長期記憶／プロファイル管理 | 1-2ヶ月 |
| **④ 拡張性** | プラグインAPI／カスタムキャラ／マルチモーダル | 2-3ヶ月 |
| **⑤ UI/UX** | WebUI／3Dアバター／音声対応 | 2-3ヶ月 |
| **⑥ 成長** | LoRA統合／KPI自動調整／A/Bテスト | 1-2ヶ月 |
| **⑦ スケール** | マルチユーザー／クラウド対応／監視強化 | 2-3ヶ月 |

---

## 17. 技術スタック（完全版）

### コア
- **Python 3.11+**
- **LangGraph** (状態管理)
- **LangChain** (ツール統合)
- **Ollama** (ローカルLLM)

### データ層
- **SQLite** (全記憶層を統合管理)
- **DuckDB** (分析・アーカイブ)
- **Pinecone/Qdrant** (VectorDB - オプション)

### API・外部連携
- **Serper API** (Web検索)
- **OpenAI/Anthropic** (高性能LLM)
- **Whisper** (音声認識)
- **ElevenLabs** (音声合成)

### インフラ
- **Docker/Docker Compose**
- **MinIO** (オブジェクトストレージ)
- **Airflow** (ETLパイプライン)
- **Prometheus/Grafana** (監視)

---

## 18. 人間らしい対話のための追加仕様（概要）

### 18.1 感情モデル

- **Plutchikの8基本感情**: 喜び、信頼、恐れ、驚き、悲しみ、嫌悪、怒り、期待
- **感情の自然な減衰**: ホメオスタシス（中立値へ）
- **共感的応答**: ユーザー感情のミラーリング

**詳細:** [会話LLM_感情・対話仕様.md](./04_会話LLM_感情・対話仕様.md)

### 18.2 対話スタイルの動的調整

- **formality**: カジュアル ⇔ フォーマル
- **verbosity**: 簡潔 ⇔ 詳細
- **humor**: 真面目 ⇔ ユーモラス

**詳細:** [会話LLM_感情・対話仕様.md](./04_会話LLM_感情・対話仕様.md)

### 18.3 連想記憶システム

- **SQLite Graph実装**: Neo4j不要の軽量グラフDB
- **ヘッブの法則**: 共起学習による関連性強化
- **忘却曲線**: 使われない記憶の自然な減衰

**詳細:** [会話LLM_連想記憶仕様.md](./05_会話LLM_連想記憶仕様.md)

### 18.4 3D可視化パネル

- **ON/OFF切り替え可能**
- **Plotly.js + WebGL**: 高速3D描画
- **インタラクティブ操作**: ズーム・回転・ノードクリック

**詳細:** [会話LLM_3D可視化仕様.md](./06_会話LLM_3D可視化仕様.md)

---

## 19. 目的再定義（最終版）

> **このシステムの究極の目標は**
> "AIが人間のように**感情を持ち、記憶し、学び、成長し、
> 真の意味でユーザーと「心の通った関係性」を構築すること"**
>
> **永続的記憶システム**により過去の全てを記憶し、
> **連想記憶**により人間らしい想起を行い、
> **感情モデル**により共感的に応答し、
> **自己省察**により自ら改善し、
> **対話スタイル適応**によりユーザーに最適化される。
>
> これは単なるチャットボットではなく、
> **人間のように考え、感じ、記憶し、成長する対話パートナー**である。

---

## 20. 将来的な拡張計画

### 20.1 セキュリティ・プライバシー強化 🔒
- データ暗号化（AES-256）
- OAuth 2.0 / JWT認証
- GDPR完全対応

### 20.2 パフォーマンス最適化 ⚡
- Redis L1キャッシュ
- 負荷分散・自動スケーリング
- GPU最適化

### 20.3 エラーハンドリング・リカバリ 🛡️
- LLM応答タイムアウト対策
- フォールバック戦略
- 自動再試行

### 20.4 テスト戦略 🧪
- ユニットテスト（pytest）
- 統合テスト
- パフォーマンステスト（Locust/k6）

### 20.5 国際化・多言語対応 🌐
- UI多言語サポート（i18next）
- 多言語埋め込み（mBERT/XLM-R）

### 20.6 モニタリング・可観測性 📊
- Prometheus + Grafana
- 分散トレーシング（Jaeger/Zipkin）
- アラート管理

---

## 21. 一般的なチャットLLM機能（Phase 1必須）

### 21.1 レスポンス制御
- temperature, top_p, top_k調整
- ストリーミングレスポンス
- 有害コンテンツフィルタ

### 21.2 ユーザー管理・認証
- JWT認証
- ロールベースアクセス制御（RBAC）

### 21.3 コンテンツモデレーション
- 有害コンテンツチェック
- PII（個人情報）検出・マスキング

### 21.4 レート制限・クォータ管理
- Free: 100リクエスト/分
- Pro: 1000リクエスト/分

### 21.5 データポータビリティ
- 全データエクスポート（JSON/CSV）
- ユーザーデータ完全削除（GDPR）

### 21.6 WebUI基本設計
- React 18 + TypeScript
- Material-UI / shadcn/ui
- FastAPI (WebSocket)

---

## 22. REST/WebSocket API 完全設計 🌐

**優先度: 高（Phase 1拡張）**

### 22.1 主要エンドポイント

```python
# REST API
POST   /api/v1/chat              # メッセージ送信
GET    /api/v1/memories          # 記憶検索
DELETE /api/v1/memories/{id}     # 記憶削除
GET    /api/v1/characters        # キャラクター一覧

# WebSocket
WS     /api/v1/stream            # リアルタイム対話
```

### 22.2 認証・レート制限
- **JWT Access Token**: 認証
- **レート制限**: Redis使用
- **CORS設定**: 許可オリジン管理

---

## 23. MCP (Model Context Protocol) 対応 🔌

**優先度: 中（Phase 1拡張）**

### 23.1 MCP Server実装

```python
class LlmMultiChatMCPServer(Server):
    """会話LLMシステムをMCP Serverとして公開"""
    
    @tool()
    async def chat_with_character(character: str, message: str): ...
    
    @tool()
    async def search_memories(query: str): ...
    
    @resource("character://lumina")
    async def get_lumina_info(): ...
```

### 23.2 公開ツール・リソース

| ツール名 | 説明 |
|---------|------|
| `chat_with_character` | キャラクター指名会話 |
| `search_memories` | 記憶検索 |
| `autonomous_search` | 自律的Web検索 |

---

## 24. 自律的外部サーチ・情報収集エージェント 🤖

**優先度: 高（Phase 1拡張）**

### 24.1 トリガー条件

1. **ユーザー質問時**: 既存知識ベースに情報がない場合
2. **定期実行**: 日次/週次で最新情報を収集
3. **手動トリガー**: 管理者による明示的な更新指示

### 24.2 自律サーチエージェント

```python
class AutonomousSearchAgent:
    """自律的外部サーチ・情報収集エージェント"""
    
    tools = [
        "web_search",           # Serper API
        "knowledge_base_query", # 既存KB検索
        "wikipedia_search",     # Wikipedia
        "save_to_kb"           # KB保存
    ]
```

### 24.3 定期更新スケジューラ

- **毎朝6時**: ニュース・トレンド更新
- **毎週日曜日**: 映画情報更新
- **毎月1日**: 技術情報更新

---

## 付録: 基本的な会話フロー

```python
async def process_user_input(user_id, session_id, message):
    # 1. 記憶参照
    context = retrieve_relevant_memory(message, user_id)
    
    # 2. ルーティング
    selected_chars = router.select_characters(message, context)
    
    # 3. 並列実行
    responses = await asyncio.gather(*[
        char.generate_response(message, context)
        for char in selected_chars
    ])
    
    # 4. 短期記憶へ保存
    state.add_turns(responses)
    
    # 5. 必要ならflush
    if state.should_flush():
        flush_to_mid_term(session_id, state.turns)
    
    return responses
```

---

## 関連ドキュメント

- **詳細仕様書**:
  - [会話LLM_記憶システム仕様.md](./02_会話LLM_記憶システム仕様.md) - 記憶階層の完全仕様
  - [会話LLM_キャラクター仕様.md](./03_会話LLM_キャラクター仕様.md) - キャラクター・成長システム
  - [会話LLM_感情・対話仕様.md](./04_会話LLM_感情・対話仕様.md) - 感情・対話スタイル
  - [会話LLM_連想記憶仕様.md](./05_会話LLM_連想記憶仕様.md) - 連想記憶・グラフDB
  - [会話LLM_3D可視化仕様.md](./06_会話LLM_3D可視化仕様.md) - 3D可視化パネル
- **実装仕様書**: [会話LLM_実装仕様書.md](../会話LLM_実装仕様書.md)
- **完了報告**: [Phase3_完了サマリー.md](../完了報告/Phase3_完了サマリー.md)

---

**ドキュメント更新日:** 2025-11-19
**担当:** LUMINA SYSTEM DESIGN TEAM
**バージョン:** 3.1.0（API・MCP・自律サーチ対応版）

**バージョン3.1.0の新機能:**
- 🌐 **REST/WebSocket API完全設計** - FastAPI実装、JWT認証、ストリーミング対応（セクション22）
- 🔌 **MCP (Model Context Protocol) 対応** - Claude Desktopなど外部エコシステムとの統合（セクション23）
- 🤖 **自律的外部サーチ・情報収集エージェント** - 知識ベース自動更新、定期実行スケジューラ（セクション24）

**バージョン3.0.0の主な追加機能:**
- ✨ 感情モデル（8基本感情 + 気分履歴）
- 🎭 対話スタイルの動的調整
- 🧠 記憶の重要度判定（感情・新規性・関連性）
- 🪞 自己省察機能（メタ認知）
- 🔗 対話の一貫性チェック
- 👤 ペルソナ一貫性の維持
- ⏱️ 自然なタイミング・待ち時間
- 🔄 トピック追跡とスムーズな転換

**バージョン履歴:**
- **v3.1.0 (2025-11-19)**: API・MCP・自律サーチ追加（Phase 1拡張）+ 5ファイル分割整理
- **v3.0.0 (2025-11-11)**: 人間らしい対話システム完全版
- **v2.0.0**: 永続的記憶システム、マルチLLM・マルチユーザー対応
