# Phase 6 å®Ÿè£…ä»•æ§˜æ›¸

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: LlmMultiChat3  
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 6 - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æˆé•· + MCPå¯¾å¿œ  
**æœŸé–“**: 4é€±é–“  
**ä½œæˆæ—¥**: 2025-11-20  
**Phase 5å®Œäº†å‰æ**: å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«é©å¿œãƒ»è‡ªå·±çœå¯Ÿå®Ÿè£…æ¸ˆã¿

---

## ç›®æ¬¡

1. [Phase 6æ¦‚è¦](#1-phase-6æ¦‚è¦)
2. [å‰ææ¡ä»¶](#2-å‰ææ¡ä»¶)
3. [Week 1-2: KPIãƒ™ãƒ¼ã‚¹æˆé•·ã‚·ã‚¹ãƒ†ãƒ ](#3-week-1-2-kpiãƒ™ãƒ¼ã‚¹æˆé•·ã‚·ã‚¹ãƒ†ãƒ )
4. [Week 3-4: MCP Serverå®Ÿè£…](#4-week-3-4-mcp-serverå®Ÿè£…)
5. [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#5-æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
6. [ãƒ†ã‚¹ãƒˆè¨ˆç”»ï¼ˆTDDå®Ÿè£…ï¼‰](#6-ãƒ†ã‚¹ãƒˆè¨ˆç”»tddå®Ÿè£…)
   - [TDDå®Ÿè£…ä»•æ§˜ã‚µãƒžãƒªãƒ¼](#60-tddå®Ÿè£…ä»•æ§˜ã‚µãƒžãƒªãƒ¼)
   - [ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™](#61-ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™)
   - [ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•](#62-ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•)
   - [Week 1-2: KPIãƒ™ãƒ¼ã‚¹æˆé•·ã‚·ã‚¹ãƒ†ãƒ  - ãƒ†ã‚¹ãƒˆä»•æ§˜ï¼ˆTDDï¼‰](#week-1-2-kpiãƒ™ãƒ¼ã‚¹æˆé•·ã‚·ã‚¹ãƒ†ãƒ ---ãƒ†ã‚¹ãƒˆä»•æ§˜tdd)
   - [Week 3-4: MCP Serverå®Ÿè£… - ãƒ†ã‚¹ãƒˆä»•æ§˜ï¼ˆTDDï¼‰](#week-3-4-mcp-serverå®Ÿè£…---ãƒ†ã‚¹ãƒˆä»•æ§˜tdd)
   - [çµ±åˆãƒ†ã‚¹ãƒˆä»•æ§˜ï¼ˆTDDï¼‰](#çµ±åˆãƒ†ã‚¹ãƒˆä»•æ§˜tdd)
   - [ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ä»•æ§˜](#ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ä»•æ§˜)
   - [ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæˆ¦ç•¥](#ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæˆ¦ç•¥)
7. [æˆæžœç‰©](#7-æˆæžœç‰©)
8. [Phase 6æˆåŠŸåŸºæº–](#8-phase-6æˆåŠŸåŸºæº–)

---

## 1. Phase 6æ¦‚è¦

### 1.1 ç›®çš„

KPIãƒ™ãƒ¼ã‚¹ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æˆé•·ã‚·ã‚¹ãƒ†ãƒ ã¨MCP Serverå®Ÿè£…ã«ã‚ˆã‚Šã€**é•·æœŸé‹ç”¨ã§ã®é€²åŒ–ã¨å¤–éƒ¨é€£æº**ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### 1.2 TDDå®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

Phase 6ã¯**ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼ˆTDDï¼‰**ã§å®Ÿè£…ã—ã¾ã™ã€‚å„æ©Ÿèƒ½ã¯ä»¥ä¸‹ã®ã‚µã‚¤ã‚¯ãƒ«ã§é–‹ç™ºã—ã¾ã™ï¼š

```
1. ðŸ”´ RED: ãƒ†ã‚¹ãƒˆã‚’æ›¸ãï¼ˆå¤±æ•—ã™ã‚‹ï¼‰
2. ðŸŸ¢ GREEN: æœ€å°é™ã®å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆã‚’é€šã™
3. ðŸ”µ REFACTOR: ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆãƒ†ã‚¹ãƒˆã¯å¸¸ã«æˆåŠŸï¼‰
```

**TDDã®åŽŸå‰‡**:
- âœ… å®Ÿè£…å‰ã«å¿…ãšãƒ†ã‚¹ãƒˆã‚’æ›¸ã
- âœ… 1ã¤ã®ãƒ†ã‚¹ãƒˆ â†’ 1ã¤ã®å®Ÿè£… â†’ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®ã‚µã‚¤ã‚¯ãƒ«
- âœ… Given-When-Thenå½¢å¼ã§ãƒ†ã‚¹ãƒˆã‚’è¨˜è¿°
- âœ… å„ãƒ†ã‚¹ãƒˆã¯ç‹¬ç«‹ã—ã¦å®Ÿè¡Œå¯èƒ½
- âœ… å¤–éƒ¨ä¾å­˜ã¯ãƒ¢ãƒƒã‚¯ã§åˆ†é›¢

### 1.2 ä¸»è¦æ©Ÿèƒ½

| æ©Ÿèƒ½ã‚«ãƒ†ã‚´ãƒª | èª¬æ˜Ž | Priority |
|-------------|------|----------|
| **KPIåŽé›†** | ãƒ¦ãƒ¼ã‚¶ãƒ¼è©•ä¾¡ãƒ»ä¼šè©±å›žæ•°è¿½è·¡ | ðŸ”´ High |
| **ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—** | è‡ªå‹•æˆé•·ãƒ»æ©Ÿèƒ½è§£ç¦ | ðŸ”´ High |
| **MCP Server** | å¤–éƒ¨ãƒ„ãƒ¼ãƒ«å…¬é–‹ | ðŸŸ¡ Medium |
| **ãƒªã‚½ãƒ¼ã‚¹å…¬é–‹** | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±æä¾› | ðŸŸ¡ Medium |

### 1.3 é”æˆç›®æ¨™

âœ… KPIåŽé›†ãƒ»ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—è‡ªå‹•åŒ–  
âœ… MCP Serverèµ·å‹•ãƒ»å¤–éƒ¨æŽ¥ç¶šæˆåŠŸ  
âœ… Claude Desktopçµ±åˆç¢ºèª  
âœ… æˆé•·ã«ã‚ˆã‚‹ä¼šè©±ã‚¹ã‚¿ã‚¤ãƒ«å¤‰åŒ–

---

## 2. å‰ææ¡ä»¶

### 2.1 Phase 1-5å®Œäº†äº‹é …

âœ… **Phase 1**: LangGraphã‚³ã‚¢ãƒ»5éšŽå±¤è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ   
âœ… **Phase 2**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£  
âœ… **Phase 3**: REST/WebSocket APIï¼ˆ23ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰  
âœ… **Phase 4**: é€£æƒ³è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ ãƒ»æ„Ÿæƒ…ãƒ¢ãƒ‡ãƒ«åŸºç›¤  
âœ… **Phase 5**: å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«é©å¿œãƒ»è‡ªå·±çœå¯Ÿ

**å‚ç…§**: [`docks/å®Ÿè£…ä»•æ§˜/Phase5_å®Ÿè£…ä»•æ§˜.md`](Phase5_å®Ÿè£…ä»•æ§˜.md:1)

### 2.2 åˆ©ç”¨å¯èƒ½ãªPhase 5æ©Ÿèƒ½

- **å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«é©å¿œ**: [`core/dialogue_style.py`](../../core/dialogue_style.py)
- **è‡ªå·±çœå¯Ÿ**: [`core/self_reflection.py`](../../core/self_reflection.py)

---

## 3. Week 1-2: KPIãƒ™ãƒ¼ã‚¹æˆé•·ã‚·ã‚¹ãƒ†ãƒ 

### 3.1 å®Ÿè£…å†…å®¹

**å‚ç…§**: [`docks/ä»•æ§˜æ›¸/03_ä¼šè©±LLM_ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä»•æ§˜.md:246-333`](../ä»•æ§˜æ›¸/03_ä¼šè©±LLM_ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä»•æ§˜.md:246)

#### 3.1.1 KPIåŽé›†

**5ç¨®é¡žã®KPI**:

```python
{
    "user_thumbs_up": 0,      # ãƒ¦ãƒ¼ã‚¶ãƒ¼è©•ä¾¡ ðŸ‘
    "answer_hits": 0,          # æŽ¨è–¦ãŒæŽ¡ç”¨ã•ã‚ŒãŸå›žæ•°
    "search_success": 0,       # æ¤œç´¢çµæžœãŒå½¹ç«‹ã£ãŸå›žæ•°
    "conversation_count": 0,   # ä¼šè©±å‚åŠ å›žæ•°
    "topic_expertise": {}      # ãƒˆãƒ”ãƒƒã‚¯åˆ¥å°‚é–€æ€§ {"Python": 10, "ML": 5}
}
```

#### 3.1.2 ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯

**è¨ˆç®—å¼**:
```python
level = floor(sqrt(total_kpi / 10))

# ä¾‹:
# total_kpi = 0   â†’ level = 0
# total_kpi = 10  â†’ level = 1
# total_kpi = 40  â†’ level = 2
# total_kpi = 90  â†’ level = 3
# total_kpi = 160 â†’ level = 4
```

**ãƒ¬ãƒ™ãƒ«åˆ¥è§£ç¦æ©Ÿèƒ½**:

| Level | è§£ç¦æ©Ÿèƒ½ |
|-------|---------|
| 0 | åŸºæœ¬ä¼šè©±ã®ã¿ |
| 1 | è¨˜æ†¶æ¤œç´¢å¼·åŒ– |
| 2 | ãƒ—ãƒ©ã‚°ã‚¤ãƒ³åˆ©ç”¨å¯èƒ½ |
| 3 | è‡ªå¾‹ã‚µãƒ¼ãƒé–‹å§‹ |
| 4 | LoRAãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°é©ç”¨ |
| 5+ | å…¨æ©Ÿèƒ½ãƒ•ãƒ«æ´»ç”¨ |

#### 3.1.3 æˆé•·çµæžœ

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è‡ªå‹•èª¿æ•´**:
- `verbosity`: ãƒ¬ãƒ™ãƒ«2ä»¥ä¸Šã§ +0.1ï¼ˆã‚ˆã‚Šè©³ç´°ãªèª¬æ˜Žï¼‰
- `proactivity`: ãƒ¬ãƒ™ãƒ«3ä»¥ä¸Šã§ +0.2ï¼ˆç©æ¥µçš„ææ¡ˆï¼‰
- `technical_level`: ãƒˆãƒ”ãƒƒã‚¯å°‚é–€æ€§ã«å¿œã˜ã¦èª¿æ•´

**å¤–è¦³æ›´æ–°**ï¼ˆå°†æ¥å®Ÿè£…ï¼‰:
- 3Dã‚¢ãƒã‚¿ãƒ¼å¤‰åŒ–
- å£°è³ªå‘ä¸Š

### 3.2 ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

#### core/character_growth.py (350è¡Œ)

```python
"""ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æˆé•·ã‚·ã‚¹ãƒ†ãƒ ."""

from typing import Dict, Any, Optional
import sqlite3
import math
from datetime import datetime


class CharacterGrowth:
    """KPIãƒ™ãƒ¼ã‚¹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æˆé•·ã‚¯ãƒ©ã‚¹."""
    
    def __init__(self, character_name: str, db_path: str = "db/character_growth.db"):
        """
        åˆæœŸåŒ–.
        
        Args:
            character_name: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å
            db_path: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹
        """
        self.character_name = character_name
        self.db_path = db_path
        self.conn = sqlite3.connect(db_path)
        self._init_schema()
        self.current_level = self._load_current_level()
    
    def _init_schema(self) -> None:
        """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒžåˆæœŸåŒ–."""
        self.conn.executescript("""
            CREATE TABLE IF NOT EXISTS character_growth (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                character_name TEXT NOT NULL,
                kpi_type TEXT NOT NULL,
                value INTEGER DEFAULT 0,
                level INTEGER DEFAULT 1,
                experience_points INTEGER DEFAULT 0,
                topic TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            
            CREATE INDEX IF NOT EXISTS idx_character_kpi 
            ON character_growth(character_name, kpi_type);
        """)
        self.conn.commit()
    
    def update_kpi(
        self,
        event_type: str,
        value: int = 1,
        topic: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        KPIæ›´æ–°.
        
        Args:
            event_type: KPIã‚¿ã‚¤ãƒ— ("user_thumbs_up", "answer_hits", etc.)
            value: åŠ ç®—å€¤
            topic: ãƒˆãƒ”ãƒƒã‚¯ï¼ˆtopic_expertiseã®å ´åˆï¼‰
        
        Returns:
            Dict: æ›´æ–°çµæžœï¼ˆãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æƒ…å ±å«ã‚€ï¼‰
        """
        cursor = self.conn.cursor()
        
        # æ—¢å­˜KPIå–å¾—
        cursor.execute("""
            SELECT id, value FROM character_growth
            WHERE character_name = ? AND kpi_type = ? AND (topic = ? OR topic IS NULL)
        """, (self.character_name, event_type, topic))
        
        row = cursor.fetchone()
        
        if row:
            # æ›´æ–°
            new_value = row[1] + value
            cursor.execute("""
                UPDATE character_growth
                SET value = ?, updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            """, (new_value, row[0]))
        else:
            # æ–°è¦ä½œæˆ
            cursor.execute("""
                INSERT INTO character_growth (character_name, kpi_type, value, topic)
                VALUES (?, ?, ?, ?)
            """, (self.character_name, event_type, value, topic))
        
        self.conn.commit()
        
        # ãƒ¬ãƒ™ãƒ«è¨ˆç®—
        new_level = self._calculate_level()
        level_up_occurred = False
        
        if new_level > self.current_level:
            level_up_occurred = True
            self._level_up(new_level)
        
        return {
            "event_type": event_type,
            "new_value": row[1] + value if row else value,
            "current_level": new_level,
            "level_up_occurred": level_up_occurred
        }
    
    def _calculate_level(self) -> int:
        """
        ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«è¨ˆç®—.
        
        Returns:
            int: ãƒ¬ãƒ™ãƒ«
        """
        cursor = self.conn.cursor()
        
        # å…¨KPIåˆè¨ˆ
        cursor.execute("""
            SELECT SUM(value) FROM character_growth
            WHERE character_name = ?
        """, (self.character_name,))
        
        total_kpi = cursor.fetchone()[0] or 0
        
        # ãƒ¬ãƒ™ãƒ«è¨ˆç®—: level = floor(sqrt(total_kpi / 10))
        level = math.floor(math.sqrt(total_kpi / 10))
        
        return level
    
    def _load_current_level(self) -> int:
        """
        ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«èª­ã¿è¾¼ã¿.
        
        Returns:
            int: ãƒ¬ãƒ™ãƒ«
        """
        cursor = self.conn.cursor()
        
        cursor.execute("""
            SELECT level FROM character_growth
            WHERE character_name = ?
            ORDER BY updated_at DESC
            LIMIT 1
        """, (self.character_name,))
        
        row = cursor.fetchone()
        return row[0] if row else 0
    
    def _level_up(self, new_level: int) -> None:
        """
        ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‡¦ç†.
        
        Args:
            new_level: æ–°ã—ã„ãƒ¬ãƒ™ãƒ«
        """
        print(f"ðŸŽ‰ {self.character_name} ãŒãƒ¬ãƒ™ãƒ« {new_level} ã«ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸï¼")
        
        # ãƒ¬ãƒ™ãƒ«è¨˜éŒ²æ›´æ–°
        cursor = self.conn.cursor()
        cursor.execute("""
            UPDATE character_growth
            SET level = ?, updated_at = CURRENT_TIMESTAMP
            WHERE character_name = ?
        """, (new_level, self.character_name))
        self.conn.commit()
        
        self.current_level = new_level
        
        # æ©Ÿèƒ½è§£ç¦
        self._unlock_new_features(new_level)
        
        # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´
        self._adjust_parameters(new_level)
        
        # å¤–è¦³æ›´æ–°ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
        # self._update_appearance(new_level)
    
    def _unlock_new_features(self, level: int) -> None:
        """
        ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸæ©Ÿèƒ½è§£ç¦.
        
        Args:
            level: ãƒ¬ãƒ™ãƒ«
        """
        features = {
            1: "è¨˜æ†¶æ¤œç´¢å¼·åŒ–",
            2: "ãƒ—ãƒ©ã‚°ã‚¤ãƒ³åˆ©ç”¨å¯èƒ½",
            3: "è‡ªå¾‹ã‚µãƒ¼ãƒé–‹å§‹",
            4: "LoRAãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°é©ç”¨",
            5: "å…¨æ©Ÿèƒ½ãƒ•ãƒ«æ´»ç”¨"
        }
        
        if level in features:
            print(f"ðŸ”“ æ–°æ©Ÿèƒ½è§£ç¦: {features[level]}")
    
    def _adjust_parameters(self, level: int) -> None:
        """
        ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´.
        
        Args:
            level: ãƒ¬ãƒ™ãƒ«
        """
        from core.dialogue_style import AdaptiveDialogueStyle
        
        # å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ï¼ˆä¾‹ï¼‰
        # style = AdaptiveDialogueStyle(user_id=f"character_{self.character_name}")
        # if level >= 2:
        #     style.parameters["verbosity"] = min(1.0, style.parameters["verbosity"] + 0.1)
        # if level >= 3:
        #     style.parameters["proactivity"] = min(1.0, style.parameters["proactivity"] + 0.2)
        # style._save_to_profile()
        
        print(f"âš™ï¸ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´å®Œäº†ï¼ˆãƒ¬ãƒ™ãƒ« {level}ï¼‰")
    
    def get_stats(self) -> Dict[str, Any]:
        """
        çµ±è¨ˆæƒ…å ±å–å¾—.
        
        Returns:
            Dict: çµ±è¨ˆæƒ…å ±
        """
        cursor = self.conn.cursor()
        
        cursor.execute("""
            SELECT kpi_type, SUM(value) as total, topic
            FROM character_growth
            WHERE character_name = ?
            GROUP BY kpi_type, topic
        """, (self.character_name,))
        
        rows = cursor.fetchall()
        
        stats = {
            "character_name": self.character_name,
            "level": self.current_level,
            "kpis": {},
            "topic_expertise": {}
        }
        
        for row in rows:
            kpi_type, total, topic = row
            if topic:
                if kpi_type not in stats["topic_expertise"]:
                    stats["topic_expertise"][kpi_type] = {}
                stats["topic_expertise"][kpi_type][topic] = total
            else:
                stats["kpis"][kpi_type] = total
        
        return stats
```

### 3.3 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒž

```sql
-- db/character_growth_schema.sql

CREATE TABLE IF NOT EXISTS character_growth (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    character_name TEXT NOT NULL,
    kpi_type TEXT NOT NULL,
    value INTEGER DEFAULT 0,
    level INTEGER DEFAULT 1,
    experience_points INTEGER DEFAULT 0,
    topic TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_character_kpi ON character_growth(character_name, kpi_type);
```

### 3.4 ãƒ†ã‚¹ãƒˆä»•æ§˜ï¼ˆTDDï¼‰

**æ³¨æ„**: ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å®Ÿè£…å‰ã®ãƒ†ã‚¹ãƒˆä»•æ§˜ã§ã™ã€‚å®Ÿè£…ã¯å¿…ãšãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã§è¡Œã„ã¾ã™ã€‚

#### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

- `tests/test_character_growth.py`: CharacterGrowthã‚¯ãƒ©ã‚¹ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆ30ä»¶ï¼‰
- `tests/test_integration_growth.py`: ChatServiceé€£æºã®çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆ10ä»¶ï¼‰

#### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å®šç¾©

```python
# tests/fixtures/character_growth_fixtures.py

TEST_CHARACTERS = ["lumina", "clarisse", "nox"]
TEST_KPI_TYPES = [
    "user_thumbs_up",
    "answer_hits", 
    "search_success",
    "conversation_count",
    "topic_expertise"
]
TEST_TOPICS = ["Python", "ML", "JavaScript", "Database"]

# ãƒ¬ãƒ™ãƒ«è¨ˆç®—ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
LEVEL_TEST_CASES = [
    {"total_kpi": 0, "expected_level": 0},
    {"total_kpi": 10, "expected_level": 1},
    {"total_kpi": 39, "expected_level": 1},  # å¢ƒç•Œå€¤
    {"total_kpi": 40, "expected_level": 2},
    {"total_kpi": 90, "expected_level": 3},
    {"total_kpi": 160, "expected_level": 4},
    {"total_kpi": 250, "expected_level": 5},
]
```

---

## 4. Week 3-4: MCP Serverå®Ÿè£…

### 4.1 å®Ÿè£…å†…å®¹

**å‚ç…§**: [`docks/ä»•æ§˜æ›¸/01_ä¼šè©±LLM_ä»•æ§˜.md:501-529`](../ä»•æ§˜æ›¸/01_ä¼šè©±LLM_ä»•æ§˜.md:501)

#### 4.1.1 MCP ServeråŸºç›¤

**MCPãƒ—ãƒ­ãƒˆã‚³ãƒ«æº–æ‹ **:
- JSON-RPC 2.0
- Server-Sent Events (SSE)
- Tools & Resourceså…¬é–‹

#### 4.1.2 å…¬é–‹ãƒ„ãƒ¼ãƒ«

```python
# 1. chat_with_character
{
    "name": "chat_with_character",
    "description": "æŒ‡å®šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ä¼šè©±",
    "inputSchema": {
        "type": "object",
        "properties": {
            "character": {"type": "string", "enum": ["lumina", "clarisse", "nox"]},
            "message": {"type": "string"}
        }
    }
}

# 2. search_memories
{
    "name": "search_memories",
    "description": "è¨˜æ†¶æ¤œç´¢",
    "inputSchema": {
        "type": "object",
        "properties": {
            "query": {"type": "string"},
            "top_k": {"type": "integer", "default": 5}
        }
    }
}

# 3. autonomous_searchï¼ˆPhase 7ã§å®Ÿè£…ï¼‰
{
    "name": "autonomous_search",
    "description": "è‡ªå¾‹Webæ¤œç´¢",
    "inputSchema": {
        "type": "object",
        "properties": {
            "topic": {"type": "string"}
        }
    }
}
```

#### 4.1.3 å…¬é–‹ãƒªã‚½ãƒ¼ã‚¹

```python
# 1. character://lumina
{
    "uri": "character://lumina",
    "name": "ãƒ«ãƒŸãƒŠæƒ…å ±",
    "description": "ãƒ«ãƒŸãƒŠã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã¨ç¾åœ¨çŠ¶æ…‹",
    "mimeType": "application/json"
}

# 2. memory://user:{id}
{
    "uri": "memory://user:123",
    "name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨˜æ†¶",
    "description": "ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨˜æ†¶æƒ…å ±",
    "mimeType": "application/json"
}
```

### 4.2 ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

#### api/mcp_server.py (400è¡Œ)

```python
"""MCP Serverå®Ÿè£…."""

from typing import Any, Dict, List
from mcp.server import Server
from mcp.server.stdio import stdio_server
from mcp.types import Tool, TextContent, Resource
import asyncio


class LlmMultiChatMCPServer:
    """LlmMultiChat3 MCP Server."""
    
    def __init__(self):
        """åˆæœŸåŒ–."""
        self.server = Server("llmmultichat3")
        self._register_tools()
        self._register_resources()
    
    def _register_tools(self) -> None:
        """ãƒ„ãƒ¼ãƒ«ç™»éŒ²."""
        
        @self.server.list_tools()
        async def list_tools() -> List[Tool]:
            """åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ä¸€è¦§."""
            return [
                Tool(
                    name="chat_with_character",
                    description="æŒ‡å®šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ä¼šè©±ã—ã¾ã™",
                    inputSchema={
                        "type": "object",
                        "properties": {
                            "character": {
                                "type": "string",
                                "enum": ["lumina", "clarisse", "nox"],
                                "description": "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å"
                            },
                            "message": {
                                "type": "string",
                                "description": "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹"
                            }
                        },
                        "required": ["character", "message"]
                    }
                ),
                Tool(
                    name="search_memories",
                    description="è¨˜æ†¶ã‚’æ¤œç´¢ã—ã¾ã™",
                    inputSchema={
                        "type": "object",
                        "properties": {
                            "query": {
                                "type": "string",
                                "description": "æ¤œç´¢ã‚¯ã‚¨ãƒª"
                            },
                            "top_k": {
                                "type": "integer",
                                "default": 5,
                                "description": "å–å¾—ä»¶æ•°"
                            }
                        },
                        "required": ["query"]
                    }
                )
            ]
        
        @self.server.call_tool()
        async def call_tool(name: str, arguments: Dict[str, Any]) -> List[TextContent]:
            """ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ."""
            if name == "chat_with_character":
                return await self._chat_with_character(
                    arguments["character"],
                    arguments["message"]
                )
            elif name == "search_memories":
                return await self._search_memories(
                    arguments["query"],
                    arguments.get("top_k", 5)
                )
            else:
                raise ValueError(f"Unknown tool: {name}")
    
    def _register_resources(self) -> None:
        """ãƒªã‚½ãƒ¼ã‚¹ç™»éŒ²."""
        
        @self.server.list_resources()
        async def list_resources() -> List[Resource]:
            """åˆ©ç”¨å¯èƒ½ãªãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§."""
            return [
                Resource(
                    uri="character://lumina",
                    name="ãƒ«ãƒŸãƒŠæƒ…å ±",
                    description="ãƒ«ãƒŸãƒŠã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã¨ç¾åœ¨çŠ¶æ…‹",
                    mimeType="application/json"
                ),
                Resource(
                    uri="character://clarisse",
                    name="ã‚¯ãƒ©ãƒªã‚¹æƒ…å ±",
                    description="ã‚¯ãƒ©ãƒªã‚¹ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã¨ç¾åœ¨çŠ¶æ…‹",
                    mimeType="application/json"
                ),
                Resource(
                    uri="character://nox",
                    name="ãƒŽã‚¯ã‚¹æƒ…å ±",
                    description="ãƒŽã‚¯ã‚¹ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã¨ç¾åœ¨çŠ¶æ…‹",
                    mimeType="application/json"
                )
            ]
        
        @self.server.read_resource()
        async def read_resource(uri: str) -> str:
            """ãƒªã‚½ãƒ¼ã‚¹å–å¾—."""
            if uri.startswith("character://"):
                character_name = uri.split("://")[1]
                return await self._get_character_info(character_name)
            else:
                raise ValueError(f"Unknown resource: {uri}")
    
    async def _chat_with_character(
        self,
        character: str,
        message: str
    ) -> List[TextContent]:
        """
        ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ä¼šè©±.
        
        Args:
            character: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å
            message: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        
        Returns:
            List[TextContent]: å¿œç­”
        """
        from services.chat_service import ChatService
        
        chat_service = ChatService()
        response = await chat_service.chat(
            user_input=message,
            character_name=character,
            session_id="mcp_session"
        )
        
        return [TextContent(type="text", text=response["response"])]
    
    async def _search_memories(
        self,
        query: str,
        top_k: int
    ) -> List[TextContent]:
        """
        è¨˜æ†¶æ¤œç´¢.
        
        Args:
            query: ã‚¯ã‚¨ãƒª
            top_k: å–å¾—ä»¶æ•°
        
        Returns:
            List[TextContent]: æ¤œç´¢çµæžœ
        """
        from memory.long_term import LongTermMemory
        
        long_term = LongTermMemory()
        results = long_term.search(query=query, top_k=top_k)
        
        formatted = "\n".join([
            f"{i+1}. {r['content']} (similarity: {r['similarity']:.2f})"
            for i, r in enumerate(results)
        ])
        
        return [TextContent(type="text", text=formatted)]
    
    async def _get_character_info(self, character_name: str) -> str:
        """
        ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±å–å¾—.
        
        Args:
            character_name: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å
        
        Returns:
            str: JSONå½¢å¼ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±
        """
        import json
        from core.character_growth import CharacterGrowth
        
        growth = CharacterGrowth(character_name)
        stats = growth.get_stats()
        
        return json.dumps(stats, ensure_ascii=False, indent=2)
    
    async def run(self):
        """MCP Serverèµ·å‹•."""
        async with stdio_server() as (read_stream, write_stream):
            await self.server.run(
                read_stream,
                write_stream,
                self.server.create_initialization_options()
            )


async def main():
    """ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ."""
    server = LlmMultiChatMCPServer()
    await server.run()


if __name__ == "__main__":
    asyncio.run(main())
```

### 4.3 Claude Desktopçµ±åˆè¨­å®š

#### claude_desktop_config.json

```json
{
  "mcpServers": {
    "llmmultichat3": {
      "command": "python",
      "args": ["-m", "api.mcp_server"],
      "cwd": "c:/GenerativeAI/LlmMultiChat3",
      "env": {
        "PYTHONPATH": "c:/GenerativeAI/LlmMultiChat3"
      }
    }
  }
}
```

### 4.4 ãƒ†ã‚¹ãƒˆä»•æ§˜ï¼ˆTDDï¼‰

**æ³¨æ„**: ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å®Ÿè£…å‰ã®ãƒ†ã‚¹ãƒˆä»•æ§˜ã§ã™ã€‚å®Ÿè£…ã¯å¿…ãšãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã§è¡Œã„ã¾ã™ã€‚

#### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

- `tests/test_mcp_server.py`: LlmMultiChatMCPServerã‚¯ãƒ©ã‚¹ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆ30ä»¶ï¼‰
- `tests/test_integration_mcp.py`: MCPçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆ10ä»¶ï¼‰

#### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å®šç¾©

```python
# tests/fixtures/mcp_server_fixtures.py

TEST_CHARACTERS = ["lumina", "clarisse", "nox"]
TEST_MESSAGES = [
    "ã“ã‚“ã«ã¡ã¯",
    "æ©Ÿæ¢°å­¦ç¿’ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„",
    "Pythonã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ãã ã•ã„",
    "",  # ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼‰
    "a" * 10000,  # é•·ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼‰
]
TEST_QUERIES = [
    "æ©Ÿæ¢°å­¦ç¿’",
    "Python",
    "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹",
    "",  # ç©ºã‚¯ã‚¨ãƒªï¼ˆã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼‰
]
TEST_TOP_K_VALUES = [1, 5, 10, 0, -1, 1000]  # æ­£å¸¸å€¤ã¨ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
```

---

## 5. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### 5.1 Pythonä¾å­˜

```txt
# requirements.txt ã«è¿½åŠ 
mcp==0.1.0              # Model Context Protocol SDK
```

### 5.2 æ–°è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

- **core/character_growth.py**: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æˆé•·ã‚·ã‚¹ãƒ†ãƒ 
- **api/mcp_server.py**: MCP Serverå®Ÿè£…

---

## 6. ãƒ†ã‚¹ãƒˆè¨ˆç”»ï¼ˆTDDå®Ÿè£…ï¼‰

### 6.0 TDDå®Ÿè£…ä»•æ§˜ã‚µãƒžãƒªãƒ¼

**Phase 6ã¯å®Œå…¨ãªTDDï¼ˆãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§å®Ÿè£…ã—ã¾ã™ã€‚**

#### TDDå®Ÿè£…ã®åŽŸå‰‡

1. **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**: ã™ã¹ã¦ã®æ©Ÿèƒ½ã¯å®Ÿè£…å‰ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
2. **RED-GREEN-REFACTORã‚µã‚¤ã‚¯ãƒ«**: å¤±æ•—â†’æˆåŠŸâ†’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’å¾¹åº•
3. **Given-When-Thenå½¢å¼**: ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’æ˜Žç¢ºãªå½¢å¼ã§è¨˜è¿°
4. **ãƒ†ã‚¹ãƒˆç‹¬ç«‹æ€§**: å„ãƒ†ã‚¹ãƒˆã¯ç‹¬ç«‹ã—ã¦å®Ÿè¡Œå¯èƒ½
5. **ãƒ¢ãƒƒã‚¯åˆ†é›¢**: å¤–éƒ¨ä¾å­˜ã¯ãƒ¢ãƒƒã‚¯ã§åˆ†é›¢ã—ã€ãƒ†ã‚¹ãƒˆã®é€Ÿåº¦ã¨ä¿¡é ¼æ€§ã‚’ç¢ºä¿

#### ãƒ†ã‚¹ãƒˆæ§‹æˆ

| ã‚«ãƒ†ã‚´ãƒª | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« | ãƒ†ã‚¹ãƒˆæ•° | ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™ | å„ªå…ˆåº¦ |
|---------|--------------|---------|--------------|--------|
| **KPIãƒ™ãƒ¼ã‚¹æˆé•·ã‚·ã‚¹ãƒ†ãƒ ** |
| CharacterGrowth | `test_character_growth.py` | 30ä»¶ + ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹8ä»¶ + ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–4ä»¶ | 95%ä»¥ä¸Š | ðŸ”´ High |
| **MCP Serverå®Ÿè£…** |
| LlmMultiChatMCPServer | `test_mcp_server.py` | 30ä»¶ + ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹10ä»¶ + ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–5ä»¶ | 90%ä»¥ä¸Š | ðŸŸ¡ Medium |
| **çµ±åˆãƒ†ã‚¹ãƒˆ** |
| ChatServiceé€£æº | `test_integration_growth.py` | 10ä»¶ | 85%ä»¥ä¸Š | ðŸŸ¡ Medium |
| MCPçµ±åˆ | `test_integration_mcp.py` | 10ä»¶ | 85%ä»¥ä¸Š | ðŸŸ¡ Medium |
| **åˆè¨ˆ** | **4ãƒ•ã‚¡ã‚¤ãƒ« + ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£2ãƒ•ã‚¡ã‚¤ãƒ«** | **107ä»¶ä»¥ä¸Š** | **å¹³å‡90%ä»¥ä¸Š** | - |

#### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæˆ¦ç•¥

- **Week 1-2**: KPIãƒ™ãƒ¼ã‚¹æˆé•·ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ6æ—¥é–“ã§æ®µéšŽçš„ã«å®Ÿè£…ï¼‰
- **Week 3-4**: MCP Serverå®Ÿè£…ï¼ˆ4æ—¥é–“ã§æ®µéšŽçš„ã«å®Ÿè£…ï¼‰
- **å„æ©Ÿèƒ½**: RED â†’ GREEN â†’ REFACTORã‚µã‚¤ã‚¯ãƒ«ã§å®Ÿè£…
- **å“è³ªåŸºæº–**: ãƒ†ã‚¹ãƒˆæˆåŠŸçŽ‡100%ã€ã‚«ãƒãƒ¬ãƒƒã‚¸90%ä»¥ä¸Šã€å®Ÿè¡Œæ™‚é–“3åˆ†ä»¥å†…

### 6.1 ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™

| ã‚«ãƒ†ã‚´ãƒª | ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ†ã‚¹ãƒˆæ•° | ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™ | å„ªå…ˆåº¦ |
|---------|---------|---------|--------------|--------|
| **KPIãƒ™ãƒ¼ã‚¹æˆé•·ã‚·ã‚¹ãƒ†ãƒ ** |
| CharacterGrowth | `test_character_growth.py` | 30 | 95%ä»¥ä¸Š | ðŸ”´ High |
| **MCP Serverå®Ÿè£…** |
| LlmMultiChatMCPServer | `test_mcp_server.py` | 30 | 90%ä»¥ä¸Š | ðŸŸ¡ Medium |
| **çµ±åˆãƒ†ã‚¹ãƒˆ** |
| ChatServiceé€£æº | `test_integration_growth.py` | 10 | 85%ä»¥ä¸Š | ðŸŸ¡ Medium |
| MCPçµ±åˆ | `test_integration_mcp.py` | 10 | 85%ä»¥ä¸Š | ðŸŸ¡ Medium |
| **åˆè¨ˆ** | **4ãƒ•ã‚¡ã‚¤ãƒ«** | **80** | **å¹³å‡90%ä»¥ä¸Š** | - |

### 6.2 ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•

#### åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest tests/test_character_growth.py tests/test_mcp_server.py -v

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest tests/ --cov=core.character_growth --cov=api.mcp_server --cov-report=html --cov-report=term

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã®ã¿
pytest tests/test_character_growth.py::test_kpi_update -v

# ãƒžãƒ¼ã‚«ãƒ¼ã§å®Ÿè¡Œ
pytest -m unit -v  # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ã¿
pytest -m integration -v  # çµ±åˆãƒ†ã‚¹ãƒˆã®ã¿
pytest -m asyncio -v  # éžåŒæœŸãƒ†ã‚¹ãƒˆã®ã¿
```

#### TDDã‚µã‚¤ã‚¯ãƒ«ã§ã®å®Ÿè¡Œ

```bash
# 1. ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ãŸå¾Œï¼ˆREDï¼‰
pytest tests/test_character_growth.py::test_kpi_update -v
# â†’ æœŸå¾…: FAILEDï¼ˆå®Ÿè£…å‰ï¼‰

# 2. æœ€å°é™ã®å®Ÿè£…å¾Œï¼ˆGREENï¼‰
pytest tests/test_character_growth.py::test_kpi_update -v
# â†’ æœŸå¾…: PASSED

# 3. ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œï¼ˆREFACTORï¼‰
pytest tests/test_character_growth.py -v
# â†’ æœŸå¾…: å…¨ãƒ†ã‚¹ãƒˆ PASSED
```

---

## Week 1-2: KPIãƒ™ãƒ¼ã‚¹æˆé•·ã‚·ã‚¹ãƒ†ãƒ  - ãƒ†ã‚¹ãƒˆä»•æ§˜ï¼ˆTDDï¼‰

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: `tests/test_character_growth.py`

**ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹**: `TestCharacterGrowth`

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§ï¼ˆ30ä»¶ï¼‰**:

#### 1. åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆï¼ˆ4ä»¶ï¼‰

```python
def test_character_growth_init():
    """
    Given: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹
    When: CharacterGrowthã‚’åˆæœŸåŒ–
    Then: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã€ãƒ¬ãƒ™ãƒ«0ã§é–‹å§‹ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    assert growth.character_name == "lumina"
    assert growth.current_level == 0
    assert growth.conn is not None

def test_character_growth_init_schema_created():
    """
    Given: CharacterGrowthã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    When: åˆæœŸåŒ–
    Then: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒžãŒä½œæˆã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("test_character", db_path=":memory:")
    
    cursor = growth.conn.cursor()
    cursor.execute("""
        SELECT name FROM sqlite_master 
        WHERE type='table' AND name='character_growth'
    """)
    
    assert cursor.fetchone() is not None

def test_character_growth_init_index_created():
    """
    Given: CharacterGrowthã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    When: åˆæœŸåŒ–
    Then: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("test_character", db_path=":memory:")
    
    cursor = growth.conn.cursor()
    cursor.execute("""
        SELECT name FROM sqlite_master 
        WHERE type='index' AND name='idx_character_kpi'
    """)
    
    assert cursor.fetchone() is not None

def test_character_growth_init_load_existing_level():
    """
    Given: æ—¢å­˜ã®ãƒ¬ãƒ™ãƒ«ãƒ‡ãƒ¼ã‚¿
    When: CharacterGrowthã‚’åˆæœŸåŒ–
    Then: æ—¢å­˜ã®ãƒ¬ãƒ™ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹
    """
    # äº‹å‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    growth1 = CharacterGrowth("existing_character", db_path=":memory:")
    growth1.update_kpi("user_thumbs_up", value=10)
    
    # æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§èª­ã¿è¾¼ã¿
    growth2 = CharacterGrowth("existing_character", db_path=":memory:")
    # æ³¨æ„: ãƒ¡ãƒ¢ãƒªDBã¯å…±æœ‰ã•ã‚Œãªã„ãŸã‚ã€å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆã§ã¯ãƒ•ã‚¡ã‚¤ãƒ«DBã‚’ä½¿ç”¨
```

#### 2. KPIæ›´æ–°ãƒ†ã‚¹ãƒˆï¼ˆ8ä»¶ï¼‰

```python
def test_update_kpi_new_kpi():
    """
    Given: æ–°ã—ã„KPIã‚¿ã‚¤ãƒ—
    When: update_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: KPIãŒæ–°è¦ä½œæˆã•ã‚Œã€å€¤ãŒè¨­å®šã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    result = growth.update_kpi("user_thumbs_up", value=1)
    
    assert result["event_type"] == "user_thumbs_up"
    assert result["new_value"] == 1
    assert result["current_level"] == 0
    assert result["level_up_occurred"] is False

def test_update_kpi_existing_kpi():
    """
    Given: æ—¢å­˜ã®KPI
    When: update_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: KPIå€¤ãŒåŠ ç®—ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    growth.update_kpi("user_thumbs_up", value=5)
    
    result = growth.update_kpi("user_thumbs_up", value=3)
    
    assert result["new_value"] == 8

def test_update_kpi_topic_expertise():
    """
    Given: ãƒˆãƒ”ãƒƒã‚¯åˆ¥å°‚é–€æ€§KPI
    When: update_kpi()ã‚’ãƒˆãƒ”ãƒƒã‚¯ä»˜ãã§å‘¼ã³å‡ºã™
    Then: ãƒˆãƒ”ãƒƒã‚¯åˆ¥ã«KPIãŒè¨˜éŒ²ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    result1 = growth.update_kpi("topic_expertise", value=10, topic="Python")
    result2 = growth.update_kpi("topic_expertise", value=5, topic="ML")
    
    assert result1["new_value"] == 10
    assert result2["new_value"] == 5
    
    stats = growth.get_stats()
    assert stats["topic_expertise"]["topic_expertise"]["Python"] == 10
    assert stats["topic_expertise"]["topic_expertise"]["ML"] == 5

def test_update_kpi_multiple_types():
    """
    Given: è¤‡æ•°ã®KPIã‚¿ã‚¤ãƒ—
    When: ãã‚Œãžã‚Œupdate_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: å„KPIãŒç‹¬ç«‹ã—ã¦è¨˜éŒ²ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    growth.update_kpi("user_thumbs_up", value=5)
    growth.update_kpi("answer_hits", value=3)
    growth.update_kpi("search_success", value=2)
    
    stats = growth.get_stats()
    assert stats["kpis"]["user_thumbs_up"] == 5
    assert stats["kpis"]["answer_hits"] == 3
    assert stats["kpis"]["search_success"] == 2

def test_update_kpi_negative_value():
    """
    Given: è² ã®å€¤
    When: update_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: KPIå€¤ãŒæ¸›å°‘ã™ã‚‹ï¼ˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ï¼‰
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    growth.update_kpi("user_thumbs_up", value=10)
    
    # å®Ÿè£…ã«å¿œã˜ã¦è² ã®å€¤ã‚’è¨±å¯ã™ã‚‹ã‹ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹ã‹
    result = growth.update_kpi("user_thumbs_up", value=-2)
    assert result["new_value"] == 8  # ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼
```

#### 3. ãƒ¬ãƒ™ãƒ«è¨ˆç®—ãƒ†ã‚¹ãƒˆï¼ˆ8ä»¶ï¼‰

```python
def test_calculate_level_zero():
    """
    Given: KPIãŒ0
    When: _calculate_level()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒ¬ãƒ™ãƒ«0ãŒè¿”ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    level = growth._calculate_level()
    
    assert level == 0

def test_calculate_level_one():
    """
    Given: total_kpi = 10
    When: _calculate_level()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒ¬ãƒ™ãƒ«1ãŒè¿”ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    growth.update_kpi("conversation_count", value=10)
    
    level = growth._calculate_level()
    
    assert level == 1

def test_calculate_level_two():
    """
    Given: total_kpi = 40
    When: _calculate_level()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒ¬ãƒ™ãƒ«2ãŒè¿”ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    growth.update_kpi("conversation_count", value=40)
    
    level = growth._calculate_level()
    
    assert level == 2

def test_calculate_level_three():
    """
    Given: total_kpi = 90
    When: _calculate_level()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒ¬ãƒ™ãƒ«3ãŒè¿”ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    growth.update_kpi("conversation_count", value=90)
    
    level = growth._calculate_level()
    
    assert level == 3

def test_calculate_level_four():
    """
    Given: total_kpi = 160
    When: _calculate_level()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒ¬ãƒ™ãƒ«4ãŒè¿”ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    growth.update_kpi("conversation_count", value=160)
    
    level = growth._calculate_level()
    
    assert level == 4

def test_calculate_level_mixed_kpis():
    """
    Given: è¤‡æ•°ã®KPIã‚¿ã‚¤ãƒ—ã®åˆè¨ˆ
    When: _calculate_level()ã‚’å‘¼ã³å‡ºã™
    Then: å…¨KPIã®åˆè¨ˆã§ãƒ¬ãƒ™ãƒ«ãŒè¨ˆç®—ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    growth.update_kpi("user_thumbs_up", value=5)
    growth.update_kpi("answer_hits", value=3)
    growth.update_kpi("search_success", value=2)
    # total = 10 â†’ level = 1
    
    level = growth._calculate_level()
    
    assert level == 1

def test_calculate_level_floor_function():
    """
    Given: ãƒ¬ãƒ™ãƒ«å¢ƒç•Œå€¤ï¼ˆä¾‹: total_kpi = 39ï¼‰
    When: _calculate_level()ã‚’å‘¼ã³å‡ºã™
    Then: flooré–¢æ•°ã§åˆ‡ã‚Šæ¨ã¦ã‚‰ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    growth.update_kpi("conversation_count", value=39)
    # sqrt(39/10) â‰ˆ 1.97 â†’ floor â†’ 1
    
    level = growth._calculate_level()
    
    assert level == 1  # åˆ‡ã‚Šæ¨ã¦
```

#### 4. ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆï¼ˆ6ä»¶ï¼‰

```python
def test_level_up_occurs():
    """
    Given: ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¡ä»¶ã‚’æº€ãŸã™KPI
    When: update_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãŒç™ºç”Ÿã—ã€level_up_occurredãŒTrue
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    # 9å›žã§ã¾ã ãƒ¬ãƒ™ãƒ«0
    for _ in range(9):
        growth.update_kpi("user_thumbs_up", value=1)
    assert growth.current_level == 0
    
    # 10å›žç›®ã§ãƒ¬ãƒ™ãƒ«1ã«
    result = growth.update_kpi("user_thumbs_up", value=1)
    
    assert result["level_up_occurred"] is True
    assert result["current_level"] == 1
    assert growth.current_level == 1

def test_level_up_multiple_levels():
    """
    Given: è¤‡æ•°ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãŒç™ºç”Ÿã™ã‚‹KPI
    When: update_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: è¤‡æ•°å›žãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãŒç™ºç”Ÿã™ã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    # 10å›žã§ãƒ¬ãƒ™ãƒ«1
    for _ in range(10):
        result = growth.update_kpi("user_thumbs_up", value=1)
    assert result["current_level"] == 1
    
    # ã•ã‚‰ã«30å›žã§ãƒ¬ãƒ™ãƒ«2
    for _ in range(30):
        result = growth.update_kpi("user_thumbs_up", value=1)
    assert result["current_level"] == 2

def test_level_up_unlock_features():
    """
    Given: ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ç™ºç”Ÿ
    When: _level_up()ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹
    Then: ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸæ©Ÿèƒ½ãŒè§£ç¦ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    # ãƒ¬ãƒ™ãƒ«1ã«åˆ°é”
    for _ in range(10):
        growth.update_kpi("user_thumbs_up", value=1)
    
    # _unlock_new_featuresãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèªï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰
    # å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆã§ã¯printå‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ç¢ºèª

def test_level_up_adjust_parameters():
    """
    Given: ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ç™ºç”Ÿ
    When: _level_up()ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹
    Then: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒèª¿æ•´ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    # ãƒ¬ãƒ™ãƒ«2ã«åˆ°é”
    for _ in range(40):
        growth.update_kpi("user_thumbs_up", value=1)
    
    # _adjust_parametersãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèªï¼ˆãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

def test_level_up_no_duplicate():
    """
    Given: åŒã˜ãƒ¬ãƒ™ãƒ«ã§ã®KPIæ›´æ–°
    When: update_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã¯ç™ºç”Ÿã—ãªã„
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    # ãƒ¬ãƒ™ãƒ«1ã«åˆ°é”
    for _ in range(10):
        growth.update_kpi("user_thumbs_up", value=1)
    
    # ã•ã‚‰ã«æ›´æ–°ï¼ˆãƒ¬ãƒ™ãƒ«1ã®ã¾ã¾ï¼‰
    result = growth.update_kpi("user_thumbs_up", value=1)
    
    assert result["level_up_occurred"] is False
    assert result["current_level"] == 1
```

#### 5. çµ±è¨ˆå–å¾—ãƒ†ã‚¹ãƒˆï¼ˆ4ä»¶ï¼‰

```python
def test_get_stats_empty():
    """
    Given: KPIãŒè¨˜éŒ²ã•ã‚Œã¦ã„ãªã„
    When: get_stats()ã‚’å‘¼ã³å‡ºã™
    Then: ç©ºã®çµ±è¨ˆæƒ…å ±ãŒè¿”ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    stats = growth.get_stats()
    
    assert stats["character_name"] == "lumina"
    assert stats["level"] == 0
    assert stats["kpis"] == {}
    assert stats["topic_expertise"] == {}

def test_get_stats_with_kpis():
    """
    Given: è¤‡æ•°ã®KPIãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹
    When: get_stats()ã‚’å‘¼ã³å‡ºã™
    Then: å…¨KPIã®çµ±è¨ˆæƒ…å ±ãŒè¿”ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    growth.update_kpi("user_thumbs_up", value=5)
    growth.update_kpi("answer_hits", value=3)
    growth.update_kpi("search_success", value=2)
    
    stats = growth.get_stats()
    
    assert stats["kpis"]["user_thumbs_up"] == 5
    assert stats["kpis"]["answer_hits"] == 3
    assert stats["kpis"]["search_success"] == 2

def test_get_stats_with_topic_expertise():
    """
    Given: ãƒˆãƒ”ãƒƒã‚¯åˆ¥å°‚é–€æ€§ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹
    When: get_stats()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒˆãƒ”ãƒƒã‚¯åˆ¥çµ±è¨ˆæƒ…å ±ãŒè¿”ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    growth.update_kpi("topic_expertise", value=10, topic="Python")
    growth.update_kpi("topic_expertise", value=5, topic="ML")
    
    stats = growth.get_stats()
    
    assert stats["topic_expertise"]["topic_expertise"]["Python"] == 10
    assert stats["topic_expertise"]["topic_expertise"]["ML"] == 5

def test_get_stats_level_included():
    """
    Given: ãƒ¬ãƒ™ãƒ«ãŒä¸ŠãŒã£ã¦ã„ã‚‹
    When: get_stats()ã‚’å‘¼ã³å‡ºã™
    Then: ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ãŒå«ã¾ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    # ãƒ¬ãƒ™ãƒ«1ã«åˆ°é”
    for _ in range(10):
        growth.update_kpi("user_thumbs_up", value=1)
    
    stats = growth.get_stats()
    
    assert stats["level"] == 1

#### 6. ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ»ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆï¼ˆè¿½åŠ : 8ä»¶ï¼‰

```python
def test_update_kpi_zero_value():
    """
    Given: value=0ã®KPIæ›´æ–°
    When: update_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: KPIå€¤ãŒå¤‰æ›´ã•ã‚Œãªã„ï¼ˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ï¼‰
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    growth.update_kpi("user_thumbs_up", value=5)
    
    result = growth.update_kpi("user_thumbs_up", value=0)
    
    assert result["new_value"] == 5  # å¤‰æ›´ãªã—

def test_update_kpi_large_value():
    """
    Given: éžå¸¸ã«å¤§ããªå€¤
    When: update_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: KPIå€¤ãŒæ­£ã—ãåŠ ç®—ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    result = growth.update_kpi("conversation_count", value=1000000)
    
    assert result["new_value"] == 1000000

def test_update_kpi_invalid_kpi_type():
    """
    Given: ç„¡åŠ¹ãªKPIã‚¿ã‚¤ãƒ—
    When: update_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ï¼ˆã¾ãŸã¯ç„¡è¦–ã•ã‚Œã‚‹ï¼‰
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    # å®Ÿè£…ã«å¿œã˜ã¦ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ç„¡è¦–
    # ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
    with pytest.raises(ValueError):
        growth.update_kpi("invalid_kpi_type", value=1)

def test_update_kpi_empty_character_name():
    """
    Given: ç©ºã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å
    When: CharacterGrowthã‚’åˆæœŸåŒ–
    Then: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ï¼ˆã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒä½¿ç”¨ã•ã‚Œã‚‹ï¼‰
    """
    # å®Ÿè£…ã«å¿œã˜ã¦ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    with pytest.raises(ValueError):
        CharacterGrowth("", db_path=":memory:")

def test_calculate_level_very_large_kpi():
    """
    Given: éžå¸¸ã«å¤§ããªKPIå€¤
    When: _calculate_level()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒ¬ãƒ™ãƒ«ãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    growth.update_kpi("conversation_count", value=1000000)
    
    level = growth._calculate_level()
    
    # sqrt(1000000/10) = sqrt(100000) â‰ˆ 316.23 â†’ floor â†’ 316
    assert level == 316

def test_get_stats_multiple_characters():
    """
    Given: è¤‡æ•°ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®KPI
    When: get_stats()ã‚’å‘¼ã³å‡ºã™
    Then: æŒ‡å®šã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®çµ±è¨ˆã®ã¿ãŒè¿”ã•ã‚Œã‚‹
    """
    growth1 = CharacterGrowth("lumina", db_path=":memory:")
    growth2 = CharacterGrowth("clarisse", db_path=":memory:")
    
    growth1.update_kpi("user_thumbs_up", value=10)
    growth2.update_kpi("user_thumbs_up", value=20)
    
    stats1 = growth1.get_stats()
    stats2 = growth2.get_stats()
    
    assert stats1["kpis"]["user_thumbs_up"] == 10
    assert stats2["kpis"]["user_thumbs_up"] == 20

def test_update_kpi_topic_expertise_same_topic():
    """
    Given: åŒã˜ãƒˆãƒ”ãƒƒã‚¯ã®è¤‡æ•°å›žæ›´æ–°
    When: update_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒˆãƒ”ãƒƒã‚¯åˆ¥KPIãŒåŠ ç®—ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    growth.update_kpi("topic_expertise", value=10, topic="Python")
    growth.update_kpi("topic_expertise", value=5, topic="Python")
    
    stats = growth.get_stats()
    assert stats["topic_expertise"]["topic_expertise"]["Python"] == 15

def test_database_connection_error():
    """
    Given: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šã‚¨ãƒ©ãƒ¼
    When: CharacterGrowthã‚’åˆæœŸåŒ–
    Then: ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹
    """
    # ç„¡åŠ¹ãªãƒ‘ã‚¹ã§ã‚¨ãƒ©ãƒ¼ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    with pytest.raises(sqlite3.Error):
        CharacterGrowth("lumina", db_path="/invalid/path/db.db")
```

#### 7. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãƒ†ã‚¹ãƒˆï¼ˆè¿½åŠ : 4ä»¶ï¼‰

```python
@pytest.mark.parametrize("kpi_type", [
    "user_thumbs_up",
    "answer_hits",
    "search_success",
    "conversation_count"
])
def test_update_kpi_all_types(kpi_type):
    """
    Given: å„KPIã‚¿ã‚¤ãƒ—
    When: update_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: ã™ã¹ã¦ã®KPIã‚¿ã‚¤ãƒ—ãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    result = growth.update_kpi(kpi_type, value=1)
    
    assert result["event_type"] == kpi_type
    assert result["new_value"] == 1

@pytest.mark.parametrize("total_kpi,expected_level", [
    (0, 0),
    (10, 1),
    (39, 1),  # å¢ƒç•Œå€¤
    (40, 2),
    (90, 3),
    (160, 4),
    (250, 5),
])
def test_calculate_level_parametrized(total_kpi, expected_level):
    """
    Given: æ§˜ã€…ãªKPIå€¤
    When: _calculate_level()ã‚’å‘¼ã³å‡ºã™
    Then: æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ãƒ™ãƒ«ãŒè¿”ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    growth.update_kpi("conversation_count", value=total_kpi)
    
    level = growth._calculate_level()
    
    assert level == expected_level

@pytest.mark.parametrize("character_name", ["lumina", "clarisse", "nox"])
def test_get_stats_all_characters(character_name):
    """
    Given: å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
    When: get_stats()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹
    """
    growth = CharacterGrowth(character_name, db_path=":memory:")
    
    stats = growth.get_stats()
    
    assert stats["character_name"] == character_name

@pytest.mark.parametrize("value", [1, 10, 100, 1000])
def test_update_kpi_various_values(value):
    """
    Given: æ§˜ã€…ãªå€¤
    When: update_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: KPIå€¤ãŒæ­£ã—ãåŠ ç®—ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    result = growth.update_kpi("user_thumbs_up", value=value)
    
    assert result["new_value"] == value
```

---

## Week 3-4: MCP Serverå®Ÿè£… - ãƒ†ã‚¹ãƒˆä»•æ§˜ï¼ˆTDDï¼‰

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: `tests/test_mcp_server.py`

**ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹**: `TestLlmMultiChatMCPServer`

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§ï¼ˆ30ä»¶ï¼‰**:

#### 1. åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆï¼ˆ3ä»¶ï¼‰

```python
@pytest.mark.asyncio
async def test_mcp_server_init():
    """
    Given: LlmMultiChatMCPServer
    When: åˆæœŸåŒ–
    Then: Serverã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã€åå‰ãŒè¨­å®šã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    assert server.server.name == "llmmultichat3"
    assert server.server is not None

@pytest.mark.asyncio
async def test_mcp_server_tools_registered():
    """
    Given: LlmMultiChatMCPServer
    When: åˆæœŸåŒ–
    Then: ãƒ„ãƒ¼ãƒ«ãŒç™»éŒ²ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    # ãƒ„ãƒ¼ãƒ«ä¸€è¦§ã‚’å–å¾—ï¼ˆãƒ¢ãƒƒã‚¯ã¾ãŸã¯å®Ÿéš›ã®MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçµŒç”±ï¼‰
    # å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆã§ã¯MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨

@pytest.mark.asyncio
async def test_mcp_server_resources_registered():
    """
    Given: LlmMultiChatMCPServer
    When: åˆæœŸåŒ–
    Then: ãƒªã‚½ãƒ¼ã‚¹ãŒç™»éŒ²ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    # ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§ã‚’å–å¾—ï¼ˆãƒ¢ãƒƒã‚¯ã¾ãŸã¯å®Ÿéš›ã®MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçµŒç”±ï¼‰
```

#### 2. ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œãƒ†ã‚¹ãƒˆï¼ˆ12ä»¶ï¼‰

```python
@pytest.mark.asyncio
async def test_chat_with_character_success():
    """
    Given: æœ‰åŠ¹ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    When: _chat_with_character()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒãƒ£ãƒƒãƒˆå¿œç­”ãŒè¿”ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    # ChatServiceã‚’ãƒ¢ãƒƒã‚¯
    with patch('api.mcp_server.ChatService') as mock_chat_service:
        mock_instance = AsyncMock()
        mock_instance.chat = AsyncMock(return_value={
            "response": "ã“ã‚“ã«ã¡ã¯ï¼",
            "character": "lumina"
        })
        mock_chat_service.return_value = mock_instance
        
        result = await server._chat_with_character("lumina", "ã“ã‚“ã«ã¡ã¯")
        
        assert len(result) > 0
        assert result[0].type == "text"
        assert "ã“ã‚“ã«ã¡ã¯" in result[0].text

@pytest.mark.asyncio
async def test_chat_with_character_invalid_character():
    """
    Given: ç„¡åŠ¹ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å
    When: _chat_with_character()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with pytest.raises(ValueError):
        await server._chat_with_character("invalid_character", "ã“ã‚“ã«ã¡ã¯")

@pytest.mark.asyncio
async def test_chat_with_character_empty_message():
    """
    Given: ç©ºã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    When: _chat_with_character()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ï¼ˆã¾ãŸã¯ç©ºã®å¿œç­”ãŒè¿”ã•ã‚Œã‚‹ï¼‰
    """
    server = LlmMultiChatMCPServer()
    
    # å®Ÿè£…ã«å¿œã˜ã¦ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ç©ºã®å¿œç­”
    result = await server._chat_with_character("lumina", "")
    # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã¾ãŸã¯ç©ºã®å¿œç­”ãƒã‚§ãƒƒã‚¯

@pytest.mark.asyncio
async def test_search_memories_success():
    """
    Given: æœ‰åŠ¹ãªæ¤œç´¢ã‚¯ã‚¨ãƒª
    When: _search_memories()ã‚’å‘¼ã³å‡ºã™
    Then: æ¤œç´¢çµæžœãŒè¿”ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    # LongTermMemoryã‚’ãƒ¢ãƒƒã‚¯
    with patch('api.mcp_server.LongTermMemory') as mock_memory:
        mock_instance = Mock()
        mock_instance.search = Mock(return_value=[
            {"content": "æ©Ÿæ¢°å­¦ç¿’ã«ã¤ã„ã¦", "similarity": 0.95},
            {"content": "Pythonã«ã¤ã„ã¦", "similarity": 0.85}
        ])
        mock_memory.return_value = mock_instance
        
        result = await server._search_memories("æ©Ÿæ¢°å­¦ç¿’", top_k=5)
        
        assert len(result) > 0
        assert result[0].type == "text"
        assert "æ©Ÿæ¢°å­¦ç¿’" in result[0].text

@pytest.mark.asyncio
async def test_search_memories_empty_results():
    """
    Given: æ¤œç´¢çµæžœãŒç©º
    When: _search_memories()ã‚’å‘¼ã³å‡ºã™
    Then: ç©ºã®çµæžœãŒè¿”ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with patch('api.mcp_server.LongTermMemory') as mock_memory:
        mock_instance = Mock()
        mock_instance.search = Mock(return_value=[])
        mock_memory.return_value = mock_instance
        
        result = await server._search_memories("å­˜åœ¨ã—ãªã„ãƒˆãƒ”ãƒƒã‚¯", top_k=5)
        
        assert len(result) > 0
        assert result[0].type == "text"

@pytest.mark.asyncio
async def test_search_memories_custom_top_k():
    """
    Given: ã‚«ã‚¹ã‚¿ãƒ top_kå€¤
    When: _search_memories()ã‚’å‘¼ã³å‡ºã™
    Then: æŒ‡å®šã•ã‚ŒãŸä»¶æ•°ã®çµæžœãŒè¿”ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with patch('api.mcp_server.LongTermMemory') as mock_memory:
        mock_instance = Mock()
        mock_instance.search = Mock(return_value=[
            {"content": f"çµæžœ{i}", "similarity": 0.9 - i*0.1}
            for i in range(10)
        ])
        mock_memory.return_value = mock_instance
        
        result = await server._search_memories("test", top_k=3)
        
        # top_k=3ã§æ¤œç´¢ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        mock_instance.search.assert_called_with(query="test", top_k=3)

@pytest.mark.asyncio
async def test_call_tool_chat_with_character():
    """
    Given: chat_with_characterãƒ„ãƒ¼ãƒ«åã¨å¼•æ•°
    When: call_tool()ã‚’å‘¼ã³å‡ºã™
    Then: _chat_with_character()ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with patch.object(server, '_chat_with_character', new_callable=AsyncMock) as mock_chat:
        mock_chat.return_value = [TextContent(type="text", text="å¿œç­”")]
        
        result = await server.server.call_tool(
            "chat_with_character",
            {"character": "lumina", "message": "ã“ã‚“ã«ã¡ã¯"}
        )
        
        mock_chat.assert_called_once_with("lumina", "ã“ã‚“ã«ã¡ã¯")

@pytest.mark.asyncio
async def test_call_tool_search_memories():
    """
    Given: search_memoriesãƒ„ãƒ¼ãƒ«åã¨å¼•æ•°
    When: call_tool()ã‚’å‘¼ã³å‡ºã™
    Then: _search_memories()ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with patch.object(server, '_search_memories', new_callable=AsyncMock) as mock_search:
        mock_search.return_value = [TextContent(type="text", text="çµæžœ")]
        
        result = await server.server.call_tool(
            "search_memories",
            {"query": "test", "top_k": 5}
        )
        
        mock_search.assert_called_once_with("test", 5)

@pytest.mark.asyncio
async def test_call_tool_unknown_tool():
    """
    Given: æœªçŸ¥ã®ãƒ„ãƒ¼ãƒ«å
    When: call_tool()ã‚’å‘¼ã³å‡ºã™
    Then: ValueErrorãŒç™ºç”Ÿã™ã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with pytest.raises(ValueError, match="Unknown tool"):
        await server.server.call_tool("unknown_tool", {})
```

#### 3. ãƒªã‚½ãƒ¼ã‚¹å–å¾—ãƒ†ã‚¹ãƒˆï¼ˆ8ä»¶ï¼‰

```python
@pytest.mark.asyncio
async def test_get_character_info_success():
    """
    Given: æœ‰åŠ¹ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å
    When: _get_character_info()ã‚’å‘¼ã³å‡ºã™
    Then: JSONå½¢å¼ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ãŒè¿”ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    # CharacterGrowthã‚’ãƒ¢ãƒƒã‚¯
    with patch('api.mcp_server.CharacterGrowth') as mock_growth:
        mock_instance = Mock()
        mock_instance.get_stats = Mock(return_value={
            "character_name": "lumina",
            "level": 2,
            "kpis": {"user_thumbs_up": 10},
            "topic_expertise": {}
        })
        mock_growth.return_value = mock_instance
        
        info = await server._get_character_info("lumina")
        
        assert isinstance(info, str)
        data = json.loads(info)
        assert data["character_name"] == "lumina"
        assert data["level"] == 2

@pytest.mark.asyncio
async def test_get_character_info_invalid_character():
    """
    Given: ç„¡åŠ¹ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å
    When: _get_character_info()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ï¼ˆã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæƒ…å ±ãŒè¿”ã•ã‚Œã‚‹ï¼‰
    """
    server = LlmMultiChatMCPServer()
    
    # å®Ÿè£…ã«å¿œã˜ã¦ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæƒ…å ±

@pytest.mark.asyncio
async def test_read_resource_character_uri():
    """
    Given: character:// URI
    When: read_resource()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ãŒè¿”ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with patch.object(server, '_get_character_info', new_callable=AsyncMock) as mock_get:
        mock_get.return_value = '{"character_name": "lumina"}'
        
        result = await server.server.read_resource("character://lumina")
        
        mock_get.assert_called_once_with("lumina")
        assert result == '{"character_name": "lumina"}'

@pytest.mark.asyncio
async def test_read_resource_unknown_uri():
    """
    Given: æœªçŸ¥ã®URI
    When: read_resource()ã‚’å‘¼ã³å‡ºã™
    Then: ValueErrorãŒç™ºç”Ÿã™ã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with pytest.raises(ValueError, match="Unknown resource"):
        await server.server.read_resource("unknown://resource")
```

#### 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆ7ä»¶ï¼‰

```python
@pytest.mark.asyncio
async def test_chat_service_error_handling():
    """
    Given: ChatServiceã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
    When: _chat_with_character()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with patch('api.mcp_server.ChatService') as mock_chat_service:
        mock_instance = AsyncMock()
        mock_instance.chat = AsyncMock(side_effect=Exception("Chat error"))
        mock_chat_service.return_value = mock_instance
        
        with pytest.raises(Exception):
            await server._chat_with_character("lumina", "test")

@pytest.mark.asyncio
async def test_memory_service_error_handling():
    """
    Given: LongTermMemoryã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
    When: _search_memories()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with patch('api.mcp_server.LongTermMemory') as mock_memory:
        mock_instance = Mock()
        mock_instance.search = Mock(side_effect=Exception("Memory error"))
        mock_memory.return_value = mock_instance
        
        with pytest.raises(Exception):
            await server._search_memories("test", top_k=5)

#### 5. ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ»ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆï¼ˆè¿½åŠ : 10ä»¶ï¼‰

```python
@pytest.mark.asyncio
async def test_chat_with_character_long_message():
    """
    Given: éžå¸¸ã«é•·ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    When: _chat_with_character()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    long_message = "a" * 10000
    
    with patch('api.mcp_server.ChatService') as mock_chat_service:
        mock_instance = AsyncMock()
        mock_instance.chat = AsyncMock(return_value={
            "response": "å¿œç­”",
            "character": "lumina"
        })
        mock_chat_service.return_value = mock_instance
        
        result = await server._chat_with_character("lumina", long_message)
        
        assert len(result) > 0

@pytest.mark.asyncio
async def test_search_memories_zero_top_k():
    """
    Given: top_k=0
    When: _search_memories()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ï¼ˆã¾ãŸã¯ç©ºã®çµæžœãŒè¿”ã•ã‚Œã‚‹ï¼‰
    """
    server = LlmMultiChatMCPServer()
    
    with patch('api.mcp_server.LongTermMemory') as mock_memory:
        mock_instance = Mock()
        mock_instance.search = Mock(return_value=[])
        mock_memory.return_value = mock_instance
        
        # å®Ÿè£…ã«å¿œã˜ã¦ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ç©ºã®çµæžœ
        result = await server._search_memories("test", top_k=0)
        assert isinstance(result, list)

@pytest.mark.asyncio
async def test_search_memories_negative_top_k():
    """
    Given: è² ã®top_kå€¤
    When: _search_memories()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with pytest.raises(ValueError):
        await server._search_memories("test", top_k=-1)

@pytest.mark.asyncio
async def test_search_memories_very_large_top_k():
    """
    Given: éžå¸¸ã«å¤§ããªtop_kå€¤
    When: _search_memories()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ï¼ˆã¾ãŸã¯ä¸Šé™å€¤ã§å‡¦ç†ã•ã‚Œã‚‹ï¼‰
    """
    server = LlmMultiChatMCPServer()
    
    with patch('api.mcp_server.LongTermMemory') as mock_memory:
        mock_instance = Mock()
        mock_instance.search = Mock(return_value=[])
        mock_memory.return_value = mock_instance
        
        # å®Ÿè£…ã«å¿œã˜ã¦ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ä¸Šé™å€¤ã§å‡¦ç†
        result = await server._search_memories("test", top_k=10000)
        assert isinstance(result, list)

@pytest.mark.asyncio
async def test_get_character_info_nonexistent_character():
    """
    Given: å­˜åœ¨ã—ãªã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å
    When: _get_character_info()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ï¼ˆã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæƒ…å ±ãŒè¿”ã•ã‚Œã‚‹ï¼‰
    """
    server = LlmMultiChatMCPServer()
    
    with patch('api.mcp_server.CharacterGrowth') as mock_growth:
        mock_instance = Mock()
        mock_instance.get_stats = Mock(side_effect=ValueError("Character not found"))
        mock_growth.return_value = mock_instance
        
        with pytest.raises(ValueError):
            await server._get_character_info("nonexistent_character")

@pytest.mark.asyncio
async def test_call_tool_missing_required_argument():
    """
    Given: å¿…é ˆå¼•æ•°ãŒæ¬ ã‘ã¦ã„ã‚‹
    When: call_tool()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with pytest.raises(KeyError):
        await server.server.call_tool(
            "chat_with_character",
            {"character": "lumina"}  # messageãŒæ¬ ã‘ã¦ã„ã‚‹
        )

@pytest.mark.asyncio
async def test_call_tool_invalid_argument_type():
    """
    Given: ç„¡åŠ¹ãªå¼•æ•°ã®åž‹
    When: call_tool()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with pytest.raises(TypeError):
        await server.server.call_tool(
            "chat_with_character",
            {"character": 123, "message": "test"}  # characterãŒæ–‡å­—åˆ—ã§ã¯ãªã„
        )

@pytest.mark.asyncio
async def test_read_resource_invalid_uri_format():
    """
    Given: ç„¡åŠ¹ãªURIå½¢å¼
    When: read_resource()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with pytest.raises(ValueError):
        await server.server.read_resource("invalid_uri")

@pytest.mark.asyncio
async def test_chat_with_character_special_characters():
    """
    Given: ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    When: _chat_with_character()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    special_message = "ã“ã‚“ã«ã¡ã¯ï¼\næ”¹è¡Œ\n\tã‚¿ãƒ–\n\"å¼•ç”¨\"\n'ã‚·ãƒ³ã‚°ãƒ«'"
    
    with patch('api.mcp_server.ChatService') as mock_chat_service:
        mock_instance = AsyncMock()
        mock_instance.chat = AsyncMock(return_value={
            "response": "å¿œç­”",
            "character": "lumina"
        })
        mock_chat_service.return_value = mock_instance
        
        result = await server._chat_with_character("lumina", special_message)
        
        assert len(result) > 0

@pytest.mark.asyncio
async def test_search_memories_special_characters_query():
    """
    Given: ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€æ¤œç´¢ã‚¯ã‚¨ãƒª
    When: _search_memories()ã‚’å‘¼ã³å‡ºã™
    Then: ã‚¯ã‚¨ãƒªãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    special_query = "Python & JavaScript | SQL"
    
    with patch('api.mcp_server.LongTermMemory') as mock_memory:
        mock_instance = Mock()
        mock_instance.search = Mock(return_value=[])
        mock_memory.return_value = mock_instance
        
        result = await server._search_memories(special_query, top_k=5)
        
        assert isinstance(result, list)
```

#### 6. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãƒ†ã‚¹ãƒˆï¼ˆè¿½åŠ : 5ä»¶ï¼‰

```python
@pytest.mark.asyncio
@pytest.mark.parametrize("character", ["lumina", "clarisse", "nox"])
async def test_chat_with_character_all_characters(character):
    """
    Given: å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
    When: _chat_with_character()ã‚’å‘¼ã³å‡ºã™
    Then: ã™ã¹ã¦ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§æ­£ã—ãå‹•ä½œã™ã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with patch('api.mcp_server.ChatService') as mock_chat_service:
        mock_instance = AsyncMock()
        mock_instance.chat = AsyncMock(return_value={
            "response": "å¿œç­”",
            "character": character
        })
        mock_chat_service.return_value = mock_instance
        
        result = await server._chat_with_character(character, "ã“ã‚“ã«ã¡ã¯")
        
        assert len(result) > 0
        assert result[0].type == "text"

@pytest.mark.asyncio
@pytest.mark.parametrize("top_k", [1, 5, 10, 20])
async def test_search_memories_various_top_k(top_k):
    """
    Given: æ§˜ã€…ãªtop_kå€¤
    When: _search_memories()ã‚’å‘¼ã³å‡ºã™
    Then: æŒ‡å®šã•ã‚ŒãŸä»¶æ•°ã§æ¤œç´¢ãŒå®Ÿè¡Œã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with patch('api.mcp_server.LongTermMemory') as mock_memory:
        mock_instance = Mock()
        mock_instance.search = Mock(return_value=[
            {"content": f"çµæžœ{i}", "similarity": 0.9 - i*0.1}
            for i in range(top_k)
        ])
        mock_memory.return_value = mock_instance
        
        result = await server._search_memories("test", top_k=top_k)
        
        mock_instance.search.assert_called_with(query="test", top_k=top_k)

@pytest.mark.asyncio
@pytest.mark.parametrize("uri", [
    "character://lumina",
    "character://clarisse",
    "character://nox"
])
async def test_read_resource_all_characters(uri):
    """
    Given: å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®URI
    When: read_resource()ã‚’å‘¼ã³å‡ºã™
    Then: ã™ã¹ã¦ã®URIã§æ­£ã—ãå‹•ä½œã™ã‚‹
    """
    server = LlmMultiChatMCPServer()
    character_name = uri.split("://")[1]
    
    with patch.object(server, '_get_character_info', new_callable=AsyncMock) as mock_get:
        mock_get.return_value = f'{{"character_name": "{character_name}"}}'
        
        result = await server.server.read_resource(uri)
        
        mock_get.assert_called_once_with(character_name)
        assert character_name in result

@pytest.mark.asyncio
@pytest.mark.parametrize("query", [
    "æ©Ÿæ¢°å­¦ç¿’",
    "Python",
    "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹",
    "è‡ªç„¶è¨€èªžå‡¦ç†"
])
async def test_search_memories_various_queries(query):
    """
    Given: æ§˜ã€…ãªæ¤œç´¢ã‚¯ã‚¨ãƒª
    When: _search_memories()ã‚’å‘¼ã³å‡ºã™
    Then: ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªã§æ­£ã—ãå‹•ä½œã™ã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    with patch('api.mcp_server.LongTermMemory') as mock_memory:
        mock_instance = Mock()
        mock_instance.search = Mock(return_value=[
            {"content": f"{query}ã«ã¤ã„ã¦", "similarity": 0.9}
        ])
        mock_memory.return_value = mock_instance
        
        result = await server._search_memories(query, top_k=5)
        
        assert len(result) > 0
        assert query in result[0].text or query in str(result[0])
```

---

## çµ±åˆãƒ†ã‚¹ãƒˆä»•æ§˜ï¼ˆTDDï¼‰

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: `tests/test_integration_growth.py`

**ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹**: `TestCharacterGrowthIntegration`

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§ï¼ˆ10ä»¶ï¼‰**:

```python
"""ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æˆé•·ã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆãƒ†ã‚¹ãƒˆ."""

import pytest
from core.character_growth import CharacterGrowth
from services.chat_service import ChatService
from unittest.mock import patch, Mock


@pytest.mark.integration
def test_kpi_update_from_chat_service():
    """
    Given: ChatServiceã‹ã‚‰KPIæ›´æ–°ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹
    When: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒðŸ‘ã‚’æŠ¼ã™
    Then: CharacterGrowthã®KPIãŒæ›´æ–°ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    # ChatServiceã®ãƒ¢ãƒƒã‚¯
    with patch('services.chat_service.ChatService') as mock_chat:
        mock_instance = Mock()
        mock_instance.record_feedback = Mock()
        mock_chat.return_value = mock_instance
        
        # KPIæ›´æ–°ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        result = growth.update_kpi("user_thumbs_up", value=1)
        
        assert result["new_value"] == 1

@pytest.mark.integration
def test_level_up_triggers_feature_unlock():
    """
    Given: ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãŒç™ºç”Ÿ
    When: æ©Ÿèƒ½è§£ç¦ãŒå®Ÿè¡Œã•ã‚Œã‚‹
    Then: å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒèª¿æ•´ã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    # ãƒ¬ãƒ™ãƒ«2ã«åˆ°é”
    for _ in range(40):
        growth.update_kpi("user_thumbs_up", value=1)
    
    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ã‚’ç¢ºèª
    stats = growth.get_stats()
    assert stats["level"] >= 2

@pytest.mark.integration
def test_multiple_characters_independent_growth():
    """
    Given: è¤‡æ•°ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
    When: ãã‚Œãžã‚ŒKPIã‚’æ›´æ–°
    Then: å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æˆé•·ãŒç‹¬ç«‹ã—ã¦ã„ã‚‹
    """
    growth1 = CharacterGrowth("lumina", db_path=":memory:")
    growth2 = CharacterGrowth("clarisse", db_path=":memory:")
    
    growth1.update_kpi("user_thumbs_up", value=10)
    growth2.update_kpi("user_thumbs_up", value=20)
    
    stats1 = growth1.get_stats()
    stats2 = growth2.get_stats()
    
    assert stats1["kpis"]["user_thumbs_up"] == 10
    assert stats2["kpis"]["user_thumbs_up"] == 20
    assert stats1["level"] != stats2["level"]

@pytest.mark.integration
def test_topic_expertise_affects_technical_level():
    """
    Given: ãƒˆãƒ”ãƒƒã‚¯åˆ¥å°‚é–€æ€§ãŒè¨˜éŒ²ã•ã‚Œã‚‹
    When: å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹
    Then: å°‚é–€æ€§ã«å¿œã˜ãŸtechnical_levelãŒè¨­å®šã•ã‚Œã‚‹
    """
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    growth.update_kpi("topic_expertise", value=50, topic="Python")
    growth.update_kpi("topic_expertise", value=30, topic="ML")
    
    stats = growth.get_stats()
    
    assert "Python" in stats["topic_expertise"]["topic_expertise"]
    assert stats["topic_expertise"]["topic_expertise"]["Python"] == 50

@pytest.mark.integration
def test_concurrent_kpi_updates():
    """
    Given: ä¸¦è¡Œã—ã¦KPIæ›´æ–°ãŒç™ºç”Ÿ
    When: è¤‡æ•°ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰update_kpi()ã‚’å‘¼ã³å‡ºã™
    Then: ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãŒä¿ãŸã‚Œã‚‹
    """
    import threading
    
    growth = CharacterGrowth("lumina", db_path=":memory:")
    
    def update_kpi_thread():
        for _ in range(10):
            growth.update_kpi("conversation_count", value=1)
    
    threads = [threading.Thread(target=update_kpi_thread) for _ in range(5)]
    for t in threads:
        t.start()
    for t in threads:
        t.join()
    
    stats = growth.get_stats()
    # 50å›žã®æ›´æ–°ãŒæ­£ã—ãè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹
    assert stats["kpis"]["conversation_count"] == 50

# ... ä»–5ä»¶ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ°¸ç¶šåŒ–ã€APIé€£æºã€ã‚¨ãƒ©ãƒ¼å›žå¾©ãªã©ï¼‰
```

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: `tests/test_integration_mcp.py`

**ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹**: `TestMCPIntegration`

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§ï¼ˆ10ä»¶ï¼‰**:

```python
"""MCP Serverçµ±åˆãƒ†ã‚¹ãƒˆ."""

import pytest
from api.mcp_server import LlmMultiChatMCPServer
from core.character_growth import CharacterGrowth
from services.chat_service import ChatService
from memory.long_term import LongTermMemory
from unittest.mock import patch, AsyncMock, Mock


@pytest.mark.integration
@pytest.mark.asyncio
async def test_mcp_chat_integration():
    """
    Given: MCP ServerçµŒç”±ã§ãƒãƒ£ãƒƒãƒˆãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™
    When: å®Ÿéš›ã®ChatServiceã‚’ä½¿ç”¨
    Then: ãƒãƒ£ãƒƒãƒˆå¿œç­”ãŒè¿”ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    # å®Ÿéš›ã®ChatServiceã‚’ä½¿ç”¨ï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰
    result = await server._chat_with_character("lumina", "ã“ã‚“ã«ã¡ã¯")
    
    assert len(result) > 0
    assert result[0].type == "text"

@pytest.mark.integration
@pytest.mark.asyncio
async def test_mcp_memory_search_integration():
    """
    Given: MCP ServerçµŒç”±ã§è¨˜æ†¶æ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™
    When: å®Ÿéš›ã®LongTermMemoryã‚’ä½¿ç”¨
    Then: æ¤œç´¢çµæžœãŒè¿”ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    # å®Ÿéš›ã®LongTermMemoryã‚’ä½¿ç”¨ï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰
    result = await server._search_memories("æ©Ÿæ¢°å­¦ç¿’", top_k=5)
    
    assert len(result) > 0
    assert result[0].type == "text"

@pytest.mark.integration
@pytest.mark.asyncio
async def test_mcp_character_info_integration():
    """
    Given: MCP ServerçµŒç”±ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã‚’å–å¾—
    When: å®Ÿéš›ã®CharacterGrowthã‚’ä½¿ç”¨
    Then: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ãŒè¿”ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    # å®Ÿéš›ã®CharacterGrowthã‚’ä½¿ç”¨ï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰
    info = await server._get_character_info("lumina")
    
    import json
    data = json.loads(info)
    assert "character_name" in data
    assert "level" in data

@pytest.mark.integration
@pytest.mark.asyncio
async def test_mcp_tool_chain():
    """
    Given: è¤‡æ•°ã®MCPãƒ„ãƒ¼ãƒ«ã‚’é€£ç¶šã—ã¦å‘¼ã³å‡ºã™
    When: ãƒãƒ£ãƒƒãƒˆ â†’ è¨˜æ†¶æ¤œç´¢ â†’ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±
    Then: ã™ã¹ã¦ã®ãƒ„ãƒ¼ãƒ«ãŒæ­£ã—ãå‹•ä½œã™ã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    # 1. ãƒãƒ£ãƒƒãƒˆ
    chat_result = await server._chat_with_character("lumina", "ã“ã‚“ã«ã¡ã¯")
    assert len(chat_result) > 0
    
    # 2. è¨˜æ†¶æ¤œç´¢
    search_result = await server._search_memories("ä¼šè©±", top_k=5)
    assert len(search_result) > 0
    
    # 3. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±
    info = await server._get_character_info("lumina")
    assert "lumina" in info.lower()

@pytest.mark.integration
@pytest.mark.asyncio
async def test_mcp_error_recovery():
    """
    Given: MCPãƒ„ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
    When: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå®Ÿè¡Œã•ã‚Œã‚‹
    Then: é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã‚‹
    """
    server = LlmMultiChatMCPServer()
    
    # ç„¡åŠ¹ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã§ã‚¨ãƒ©ãƒ¼ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    with pytest.raises((ValueError, Exception)):
        await server._chat_with_character("invalid_character", "test")

# ... ä»–5ä»¶ï¼ˆMCPãƒ—ãƒ­ãƒˆã‚³ãƒ«æº–æ‹ ã€Claude Desktopçµ±åˆã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆãªã©ï¼‰
```

---

## ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ä»•æ§˜

### conftest.py ã®æ‹¡å¼µ

```python
# tests/conftest.pyï¼ˆæ‹¡å¼µï¼‰

import pytest
import tempfile
import sqlite3
from unittest.mock import Mock, AsyncMock, patch

from core.character_growth import CharacterGrowth
from api.mcp_server import LlmMultiChatMCPServer

@pytest.fixture
def temp_db():
    """ä¸€æ™‚çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹"""
    db_path = tempfile.mktemp(suffix='.db')
    yield db_path
    import os
    if os.path.exists(db_path):
        os.remove(db_path)

@pytest.fixture
def character_growth(temp_db):
    """CharacterGrowthã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹"""
    return CharacterGrowth("test_character", db_path=temp_db)

@pytest.fixture
def mcp_server():
    """LlmMultiChatMCPServerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹"""
    return LlmMultiChatMCPServer()

@pytest.fixture
def mock_chat_service():
    """ChatServiceã®ãƒ¢ãƒƒã‚¯"""
    mock = AsyncMock()
    mock.chat = AsyncMock(return_value={
        "response": "ãƒ¢ãƒƒã‚¯å¿œç­”",
        "character": "lumina"
    })
    return mock

@pytest.fixture
def mock_long_term_memory():
    """LongTermMemoryã®ãƒ¢ãƒƒã‚¯"""
    mock = Mock()
    mock.search = Mock(return_value=[
        {"content": "ãƒ¢ãƒƒã‚¯è¨˜æ†¶", "similarity": 0.9}
    ])
    return mock
```

---

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæˆ¦ç•¥

### TDDå®Ÿè£…é †åºï¼ˆè©³ç´°ç‰ˆï¼‰

#### Week 1-2: KPIãƒ™ãƒ¼ã‚¹æˆé•·ã‚·ã‚¹ãƒ†ãƒ 

**Day 1: åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆï¼ˆ4ä»¶ï¼‰â†’ å®Ÿè£…**
```bash
# 1. ãƒ†ã‚¹ãƒˆã‚’æ›¸ãï¼ˆREDï¼‰
pytest tests/test_character_growth.py::test_character_growth_init -v
# â†’ æœŸå¾…: FAILEDï¼ˆå®Ÿè£…å‰ï¼‰

# 2. æœ€å°é™ã®å®Ÿè£…ï¼ˆGREENï¼‰
# core/character_growth.py ã‚’å®Ÿè£…
pytest tests/test_character_growth.py::test_character_growth_init -v
# â†’ æœŸå¾…: PASSED

# 3. ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆREFACTORï¼‰
# ã‚³ãƒ¼ãƒ‰ã‚’æ”¹å–„
pytest tests/test_character_growth.py -v
# â†’ æœŸå¾…: å…¨ãƒ†ã‚¹ãƒˆ PASSED
```

**Day 2: KPIæ›´æ–°ãƒ†ã‚¹ãƒˆï¼ˆ8ä»¶ + ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹8ä»¶ï¼‰â†’ å®Ÿè£…**
- æ­£å¸¸ç³»: æ–°è¦KPIã€æ—¢å­˜KPIã€ãƒˆãƒ”ãƒƒã‚¯åˆ¥å°‚é–€æ€§ã€è¤‡æ•°ã‚¿ã‚¤ãƒ—
- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹: è² ã®å€¤ã€ã‚¼ãƒ­å€¤ã€å¤§ããªå€¤ã€ç„¡åŠ¹ãªKPIã‚¿ã‚¤ãƒ—

**Day 3: ãƒ¬ãƒ™ãƒ«è¨ˆç®—ãƒ†ã‚¹ãƒˆï¼ˆ8ä»¶ + ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–4ä»¶ï¼‰â†’ å®Ÿè£…**
- æ­£å¸¸ç³»: å„ãƒ¬ãƒ™ãƒ«ã®è¨ˆç®—
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–: æ§˜ã€…ãªKPIå€¤ã§ã®ãƒ¬ãƒ™ãƒ«è¨ˆç®—

**Day 4: ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆï¼ˆ6ä»¶ï¼‰â†’ å®Ÿè£…**
- ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ç™ºç”Ÿã€è¤‡æ•°ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã€æ©Ÿèƒ½è§£ç¦ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´

**Day 5: çµ±è¨ˆå–å¾—ãƒ†ã‚¹ãƒˆï¼ˆ4ä»¶ + ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼‰â†’ å®Ÿè£…ãƒ»ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**
- ç©ºã®çµ±è¨ˆã€KPIçµ±è¨ˆã€ãƒˆãƒ”ãƒƒã‚¯åˆ¥çµ±è¨ˆã€ãƒ¬ãƒ™ãƒ«æƒ…å ±

**Day 6-10: çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆ10ä»¶ï¼‰â†’ å®Ÿè£…ãƒ»ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**
- ChatServiceé€£æºã€æ©Ÿèƒ½è§£ç¦ã€è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€ä¸¦è¡Œå‡¦ç†

#### Week 3-4: MCP Serverå®Ÿè£…

**Day 1-2: åˆæœŸåŒ–ãƒ»ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œãƒ†ã‚¹ãƒˆï¼ˆ15ä»¶ + ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹10ä»¶ + ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–5ä»¶ï¼‰â†’ å®Ÿè£…**
- åˆæœŸåŒ–: Serverä½œæˆã€ãƒ„ãƒ¼ãƒ«ç™»éŒ²ã€ãƒªã‚½ãƒ¼ã‚¹ç™»éŒ²
- ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ: ãƒãƒ£ãƒƒãƒˆã€è¨˜æ†¶æ¤œç´¢ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹: é•·ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ç‰¹æ®Šæ–‡å­—ã€ç„¡åŠ¹ãªå¼•æ•°

**Day 3: ãƒªã‚½ãƒ¼ã‚¹å–å¾—ãƒ†ã‚¹ãƒˆï¼ˆ8ä»¶ï¼‰â†’ å®Ÿè£…**
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±å–å¾—ã€URIå‡¦ç†ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**Day 4: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆ7ä»¶ + çµ±åˆãƒ†ã‚¹ãƒˆ10ä»¶ï¼‰â†’ å®Ÿè£…ãƒ»ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: ChatServiceã€LongTermMemoryã€CharacterGrowth
- çµ±åˆãƒ†ã‚¹ãƒˆ: å®Ÿéš›ã®ã‚µãƒ¼ãƒ“ã‚¹é€£æºã€ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã€ã‚¨ãƒ©ãƒ¼å›žå¾©

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰ï¼ˆè©³ç´°ç‰ˆï¼‰

#### åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest tests/test_character_growth.py tests/test_mcp_server.py \
       tests/test_integration_growth.py tests/test_integration_mcp.py -v

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest tests/ \
  --cov=core.character_growth \
  --cov=api.mcp_server \
  --cov-report=html \
  --cov-report=term-missing \
  --cov-fail-under=90

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒªã®ã¿å®Ÿè¡Œ
pytest -m unit -v              # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ã¿
pytest -m integration -v      # çµ±åˆãƒ†ã‚¹ãƒˆã®ã¿
pytest -m asyncio -v          # éžåŒæœŸãƒ†ã‚¹ãƒˆã®ã¿
pytest -m "not slow" -v      # é…ã„ãƒ†ã‚¹ãƒˆã‚’é™¤å¤–

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å®Ÿè¡Œ
pytest tests/test_character_growth.py -v
pytest tests/test_mcp_server.py -v

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆé–¢æ•°ã®ã¿å®Ÿè¡Œ
pytest tests/test_character_growth.py::test_kpi_update -v
pytest tests/test_character_growth.py::TestCharacterGrowth::test_kpi_update -v

# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãƒ†ã‚¹ãƒˆã®ç‰¹å®šã‚±ãƒ¼ã‚¹ã®ã¿å®Ÿè¡Œ
pytest tests/test_character_growth.py::test_calculate_level_parametrized[40-2] -v
```

#### TDDã‚µã‚¤ã‚¯ãƒ«ã§ã®å®Ÿè¡Œ

```bash
# 1. ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ãŸå¾Œï¼ˆREDï¼‰
pytest tests/test_character_growth.py::test_kpi_update -v
# â†’ æœŸå¾…: FAILEDï¼ˆå®Ÿè£…å‰ï¼‰

# 2. æœ€å°é™ã®å®Ÿè£…å¾Œï¼ˆGREENï¼‰
pytest tests/test_character_growth.py::test_kpi_update -v
# â†’ æœŸå¾…: PASSED

# 3. ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œï¼ˆREFACTORï¼‰
pytest tests/test_character_growth.py -v
# â†’ æœŸå¾…: å…¨ãƒ†ã‚¹ãƒˆ PASSED

# 4. ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª
pytest tests/test_character_growth.py --cov=core.character_growth --cov-report=term
# â†’ æœŸå¾…: ã‚«ãƒãƒ¬ãƒƒã‚¸ > 90%
```

#### ä¸¦åˆ—å®Ÿè¡Œï¼ˆé«˜é€ŸåŒ–ï¼‰

```bash
# pytest-xdistã‚’ä½¿ç”¨ã—ãŸä¸¦åˆ—å®Ÿè¡Œ
pip install pytest-xdist

# 4ä¸¦åˆ—ã§å®Ÿè¡Œ
pytest tests/ -n 4

# CPUã‚³ã‚¢æ•°ã«å¿œã˜ã¦è‡ªå‹•ä¸¦åˆ—æ•°æ±ºå®š
pytest tests/ -n auto

# ä¸¦åˆ—å®Ÿè¡Œæ™‚ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆæ³¨æ„: ã‚«ãƒãƒ¬ãƒƒã‚¸ã¯ä¸¦åˆ—å®Ÿè¡Œã¨ç›¸æ€§ãŒæ‚ªã„ï¼‰
pytest tests/ -n 4 --cov=core.character_growth --cov=api.mcp_server
```

#### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã®æ¸¬å®š

```bash
# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã‚’è¡¨ç¤º
pytest tests/ --durations=10

# é…ã„ãƒ†ã‚¹ãƒˆã‚’ç‰¹å®š
pytest tests/ --durations=0

# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆpytest-timeoutä½¿ç”¨ï¼‰
pip install pytest-timeout
pytest tests/ --timeout=300  # 5åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
```

#### ãƒ†ã‚¹ãƒˆã®ãƒ‡ãƒãƒƒã‚°

```bash
# è©³ç´°ãªå‡ºåŠ›
pytest tests/ -v -s

# æœ€åˆã®å¤±æ•—ã§åœæ­¢
pytest tests/ -x

# æœ€å¾Œã®å¤±æ•—ã‹ã‚‰å†å®Ÿè¡Œ
pytest tests/ --lf

# å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®ã¿å†å®Ÿè¡Œ
pytest tests/ --ff

# ãƒ‡ãƒãƒƒã‚¬ãƒ¼ã§å®Ÿè¡Œ
pytest tests/ --pdb
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé †åºã¨ä¾å­˜é–¢ä¿‚

#### ãƒ†ã‚¹ãƒˆã®ä¾å­˜é–¢ä¿‚ç®¡ç†

```python
# pytest-dependencyã‚’ä½¿ç”¨
pip install pytest-dependency

# ãƒ†ã‚¹ãƒˆã«ä¾å­˜é–¢ä¿‚ã‚’å®šç¾©
@pytest.mark.dependency(depends=["test_character_growth_init"])
def test_kpi_update():
    """KPIæ›´æ–°ãƒ†ã‚¹ãƒˆï¼ˆåˆæœŸåŒ–ã«ä¾å­˜ï¼‰"""
    pass

# ä¾å­˜ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
pytest tests/ --skip-dependency
```

#### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé †åºã®åˆ¶å¾¡

```python
# pytest-orderã‚’ä½¿ç”¨
pip install pytest-order

# ãƒ†ã‚¹ãƒˆã«é †åºã‚’å®šç¾©
@pytest.mark.order(1)
def test_character_growth_init():
    """æœ€åˆã«å®Ÿè¡Œ"""
    pass

@pytest.mark.order(2)
def test_kpi_update():
    """2ç•ªç›®ã«å®Ÿè¡Œ"""
    pass
```

### CI/CDã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```yaml
# .github/workflows/test.ymlï¼ˆä¾‹ï¼‰
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist
      - name: Run tests
        run: |
          pytest tests/ \
            --cov=core.character_growth \
            --cov=api.mcp_server \
            --cov-report=xml \
            --cov-report=html \
            --junitxml=junit.xml \
            -n auto
      - name: Upload coverage
        uses: codecov/codecov-action@v2
        with:
          files: ./coverage.xml
```

### ãƒ†ã‚¹ãƒˆå“è³ªåŸºæº–

**å¿…é ˆè¦ä»¶**:
- âœ… **ãƒ†ã‚¹ãƒˆæˆåŠŸçŽ‡**: 100%ï¼ˆå…¨ãƒ†ã‚¹ãƒˆãŒæˆåŠŸï¼‰
  - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: 60ä»¶ï¼ˆCharacterGrowth: 30ä»¶ã€MCP Server: 30ä»¶ï¼‰
  - çµ±åˆãƒ†ã‚¹ãƒˆ: 20ä»¶ï¼ˆæˆé•·ã‚·ã‚¹ãƒ†ãƒ : 10ä»¶ã€MCP: 10ä»¶ï¼‰
  - **åˆè¨ˆ**: 80ä»¶ä»¥ä¸Š
- âœ… **ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸**: 90%ä»¥ä¸Šï¼ˆå¹³å‡ï¼‰
  - CharacterGrowth: 95%ä»¥ä¸Š
  - MCP Server: 90%ä»¥ä¸Š
- âœ… **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“**: å…¨ãƒ†ã‚¹ãƒˆ3åˆ†ä»¥å†…
  - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: 1åˆ†ä»¥å†…
  - çµ±åˆãƒ†ã‚¹ãƒˆ: 2åˆ†ä»¥å†…
- âœ… **ãƒ†ã‚¹ãƒˆç‹¬ç«‹æ€§**: å„ãƒ†ã‚¹ãƒˆã¯ç‹¬ç«‹ã—ã¦å®Ÿè¡Œå¯èƒ½
  - ãƒ†ã‚¹ãƒˆé–“ã®ä¾å­˜é–¢ä¿‚ãªã—
  - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé †åºã«ä¾å­˜ã—ãªã„
- âœ… **ãƒ¢ãƒƒã‚¯ä½¿ç”¨**: å¤–éƒ¨ä¾å­˜ï¼ˆChatServiceã€LongTermMemoryç­‰ï¼‰ã¯ãƒ¢ãƒƒã‚¯ã§åˆ†é›¢
  - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: ã™ã¹ã¦ã®å¤–éƒ¨ä¾å­˜ã‚’ãƒ¢ãƒƒã‚¯
  - çµ±åˆãƒ†ã‚¹ãƒˆ: å®Ÿéš›ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨

**TDDã‚µã‚¤ã‚¯ãƒ«éµå®ˆ**:
- âœ… **RED**: å®Ÿè£…å‰ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã„ã‚‹
  - ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
  - ãƒ†ã‚¹ãƒˆãŒæœŸå¾…ã™ã‚‹å‹•ä½œã‚’æ˜Žç¢ºã«å®šç¾©
- âœ… **GREEN**: æœ€å°é™ã®å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆã‚’é€šã—ã¦ã„ã‚‹
  - ãƒ†ã‚¹ãƒˆã‚’é€šã™æœ€å°é™ã®ã‚³ãƒ¼ãƒ‰ã®ã¿å®Ÿè£…
  - éŽåº¦ãªå®Ÿè£…ã‚’é¿ã‘ã‚‹
- âœ… **REFACTOR**: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã‚‚ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã‚‹
  - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã‚‚å…¨ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ
  - ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ä¿å®ˆæ€§ã‚’å‘ä¸Š

**ãƒ†ã‚¹ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**:
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒGiven-When-Thenå½¢å¼ã§è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ†ã‚¹ãƒˆåãŒæ˜Žç¢ºã§èª¬æ˜Žçš„ã§ã‚ã‚‹
- [ ] å„ãƒ†ã‚¹ãƒˆãŒ1ã¤ã®ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã‚‹
- [ ] ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒé©åˆ‡ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãŒååˆ†ã«ã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ã‚‹
- [ ] ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãƒ†ã‚¹ãƒˆãŒé©åˆ‡ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ¢ãƒƒã‚¯ãŒé©åˆ‡ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ™‚é–“ãŒè¨±å®¹ç¯„å›²å†…ã§ã‚ã‚‹
- [ ] ãƒ†ã‚¹ãƒˆã®ä¿å®ˆæ€§ãŒç¢ºä¿ã•ã‚Œã¦ã„ã‚‹

---

## 7. æˆæžœç‰©

### 7.1 å®Ÿè£…ã‚³ãƒ¼ãƒ‰

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**:
- `core/character_growth.py` (350è¡Œ)
- `api/mcp_server.py` (400è¡Œ)
- **åˆè¨ˆ**: 750è¡Œ

### 7.2 ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**:
- `tests/test_character_growth.py` (30ä»¶)
  - åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ: 4ä»¶
  - KPIæ›´æ–°ãƒ†ã‚¹ãƒˆ: 8ä»¶ + ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹8ä»¶
  - ãƒ¬ãƒ™ãƒ«è¨ˆç®—ãƒ†ã‚¹ãƒˆ: 8ä»¶ + ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–4ä»¶
  - ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ: 6ä»¶
  - çµ±è¨ˆå–å¾—ãƒ†ã‚¹ãƒˆ: 4ä»¶
- `tests/test_mcp_server.py` (30ä»¶)
  - åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ: 3ä»¶
  - ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œãƒ†ã‚¹ãƒˆ: 12ä»¶ + ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹10ä»¶ + ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–5ä»¶
  - ãƒªã‚½ãƒ¼ã‚¹å–å¾—ãƒ†ã‚¹ãƒˆ: 8ä»¶
  - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ: 7ä»¶
- `tests/test_integration_growth.py` (10ä»¶)
  - ChatServiceé€£æº: 3ä»¶
  - æ©Ÿèƒ½è§£ç¦ãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´: 2ä»¶
  - è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: 2ä»¶
  - ä¸¦è¡Œå‡¦ç†: 1ä»¶
  - ãã®ä»–: 2ä»¶
- `tests/test_integration_mcp.py` (10ä»¶)
  - MCPãƒ„ãƒ¼ãƒ«çµ±åˆ: 4ä»¶
  - ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³: 1ä»¶
  - ã‚¨ãƒ©ãƒ¼å›žå¾©: 1ä»¶
  - ãã®ä»–: 4ä»¶
- `tests/fixtures/character_growth_fixtures.py`: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å®šç¾©
- `tests/fixtures/mcp_server_fixtures.py`: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å®šç¾©
- **åˆè¨ˆ**: 80ä»¶ä»¥ä¸Šï¼ˆã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãƒ†ã‚¹ãƒˆå«ã‚€ï¼‰

### 7.3 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `docks/å®Œäº†å ±å‘Š/Phase6_å®Œäº†ã‚µãƒžãƒªãƒ¼.md`
- MCP Serverè¨­å®šã‚¬ã‚¤ãƒ‰
- Claude Desktopçµ±åˆã‚¬ã‚¤ãƒ‰

### 7.4 ãƒžã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³

- [ ] KPIåŽé›†ãƒ»ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‹•ä½œç¢ºèª
- [ ] MCP Serverå¤–éƒ¨æŽ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ
- [ ] Claude Desktopçµ±åˆç¢ºèª
- [ ] å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆ80ä»¶ï¼‰
- [ ] ã‚«ãƒãƒ¬ãƒƒã‚¸ > 90%

---

## 8. Phase 6æˆåŠŸåŸºæº–

### TDDå®Ÿè£…ã®æˆåŠŸåŸºæº–

**å¿…é ˆè¦ä»¶**:
- âœ… **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**: å…¨æ©Ÿèƒ½ãŒãƒ†ã‚¹ãƒˆé§†å‹•ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- âœ… **ãƒ†ã‚¹ãƒˆæˆåŠŸçŽ‡**: 100%ï¼ˆå…¨80ä»¶ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸï¼‰
- âœ… **ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸**: 90%ä»¥ä¸Šï¼ˆå¹³å‡ï¼‰
- âœ… **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“**: å…¨ãƒ†ã‚¹ãƒˆ3åˆ†ä»¥å†…
- âœ… **ãƒ†ã‚¹ãƒˆç‹¬ç«‹æ€§**: å„ãƒ†ã‚¹ãƒˆã¯ç‹¬ç«‹ã—ã¦å®Ÿè¡Œå¯èƒ½
- âœ… **ãƒ¢ãƒƒã‚¯ä½¿ç”¨**: å¤–éƒ¨ä¾å­˜ï¼ˆChatServiceã€LongTermMemoryç­‰ï¼‰ã¯ãƒ¢ãƒƒã‚¯ã§åˆ†é›¢

**TDDã‚µã‚¤ã‚¯ãƒ«éµå®ˆ**:
- âœ… RED: å®Ÿè£…å‰ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã„ã‚‹
- âœ… GREEN: æœ€å°é™ã®å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆã‚’é€šã—ã¦ã„ã‚‹
- âœ… REFACTOR: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã‚‚ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã‚‹

### å®šé‡ç›®æ¨™

| æŒ‡æ¨™ | ç›®æ¨™å€¤ | æ¸¬å®šæ–¹æ³• |
|------|--------|----------|
| **ãƒ†ã‚¹ãƒˆæˆåŠŸçŽ‡** | **100%** | pytestï¼ˆå…¨80ä»¶ï¼‰ |
| **ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸** | **90%ä»¥ä¸Š** | pytest-cov |
| **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“** | **< 3åˆ†** | pytest --durations |
| KPIåŽé›†ç²¾åº¦ | 100% | KPIæ›´æ–°ãƒ†ã‚¹ãƒˆ |
| ãƒ¬ãƒ™ãƒ«è¨ˆç®—ç²¾åº¦ | 100% | ãƒ¬ãƒ™ãƒ«è¨ˆç®—ãƒ†ã‚¹ãƒˆ |
| MCP Serverå¿œç­”æ™‚é–“ | < 500ms | MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ |

### å®šæ€§ç›®æ¨™

âœ… **TDDå®Ÿè£…å®Œäº†**: å…¨æ©Ÿèƒ½ãŒãƒ†ã‚¹ãƒˆé§†å‹•ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
âœ… **ãƒ†ã‚¹ãƒˆä»•æ§˜å®Œå‚™**: å…¨80ä»¶ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
âœ… **KPIåŽé›†å‹•ä½œ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼è©•ä¾¡ãƒ»ä¼šè©±å›žæ•°è¿½è·¡
âœ… **ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‹•ä½œ**: è‡ªå‹•æˆé•·ãƒ»æ©Ÿèƒ½è§£ç¦
âœ… **MCP Serverå‹•ä½œ**: å¤–éƒ¨ãƒ„ãƒ¼ãƒ«å…¬é–‹ãƒ»Claude Desktopçµ±åˆ

---

**Phase 6 å®Ÿè£…å®Œäº†**: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æˆé•·ã‚·ã‚¹ãƒ†ãƒ ã¨å¤–éƒ¨é€£æºåŸºç›¤ãŒæ•´ã„ã¾ã—ãŸã€‚