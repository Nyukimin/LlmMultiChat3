# Phase 5 å®Ÿè£…ä»•æ§˜æ›¸

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: LlmMultiChat3  
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 5 - å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«é©å¿œ + è‡ªå·±çœå¯Ÿ  
**æœŸé–“**: 4é€±é–“  
**ä½œæˆæ—¥**: 2025-11-20  
**Phase 4å®Œäº†å‰æ**: é€£æƒ³è¨˜æ†¶ãƒ»æ„Ÿæƒ…åŸºç›¤å®Ÿè£…æ¸ˆã¿

---

## ç›®æ¬¡

1. [Phase 5æ¦‚è¦](#1-phase-5æ¦‚è¦)
2. [å‰ææ¡ä»¶](#2-å‰ææ¡ä»¶)
3. [Week 1-2: å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«å‹•çš„èª¿æ•´](#3-week-1-2-å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«å‹•çš„èª¿æ•´)
4. [Week 3-4: è‡ªå·±çœå¯Ÿãƒ»ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯](#4-week-3-4-è‡ªå·±çœå¯Ÿä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯)
5. [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#5-æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
6. [ãƒ†ã‚¹ãƒˆè¨ˆç”»](#6-ãƒ†ã‚¹ãƒˆè¨ˆç”»)
7. [æˆæœç‰©](#7-æˆæœç‰©)

---

## 1. Phase 5æ¦‚è¦

### 1.1 ç›®çš„

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆã‚ã›ãŸå¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ã¨è‡ªå·±æ”¹å–„æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€**å€‹ã€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æœ€é©åŒ–ã•ã‚ŒãŸä¼šè©±ä½“é¨“**ã‚’æä¾›ã—ã¾ã™ã€‚

### 1.2 ä¸»è¦æ©Ÿèƒ½

| æ©Ÿèƒ½ã‚«ãƒ†ã‚´ãƒª | èª¬æ˜ | Priority |
|-------------|------|----------|
| **å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«é©å¿œ** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‹ã‚‰å­¦ç¿’ | ğŸ”´ High |
| **è‡ªå·±çœå¯Ÿ** | ä¼šè©±æŒ¯ã‚Šè¿”ã‚Šã¨ãƒ¡ã‚¿èªçŸ¥ | ğŸ”´ High |
| **çŸ›ç›¾æ¤œå‡º** | éå»ç™ºè¨€ã¨ã®ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯ | ğŸŸ¡ Medium |
| **ãƒˆãƒ”ãƒƒã‚¯è¿½è·¡** | è©±é¡Œã®æµã‚Œç®¡ç† | ğŸŸ¡ Medium |

### 1.3 é”æˆç›®æ¨™

âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«è‡ªå‹•èª¿æ•´  
âœ… è‡ªå·±çœå¯Ÿã«ã‚ˆã‚‹ç¶™ç¶šçš„æ”¹å–„  
âœ… çŸ›ç›¾æ¤œå‡ºãƒ»ä¿®æ­£ææ¡ˆ  
âœ… ãƒˆãƒ”ãƒƒã‚¯è¿½è·¡ç²¾åº¦ > 80%

---

## 2. å‰ææ¡ä»¶

### 2.1 Phase 1-4å®Œäº†äº‹é …

âœ… **Phase 1**: LangGraphã‚³ã‚¢ãƒ»5éšå±¤è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ   
âœ… **Phase 2**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£  
âœ… **Phase 3**: REST/WebSocket APIï¼ˆ23ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰  
âœ… **Phase 4**: é€£æƒ³è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ ãƒ»æ„Ÿæƒ…ãƒ¢ãƒ‡ãƒ«åŸºç›¤

**å‚ç…§**: [`docks/å®Ÿè£…ä»•æ§˜/Phase4_å®Ÿè£…ä»•æ§˜.md`](Phase4_å®Ÿè£…ä»•æ§˜.md:1)

### 2.2 åˆ©ç”¨å¯èƒ½ãªPhase 4æ©Ÿèƒ½

- **é€£æƒ³è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ **: [`memory/associative.py`](../../memory/associative.py)
- **æ„Ÿæƒ…ãƒ¢ãƒ‡ãƒ«**: [`core/emotion.py`](../../core/emotion.py)
- **APIè¿½åŠ **: `/api/v1/memory/associate`, `/api/v1/character/{name}/emotion`

---

## 3. Week 1-2: å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«å‹•çš„èª¿æ•´

### 3.1 å®Ÿè£…å†…å®¹

**å‚ç…§**: [`docks/ä»•æ§˜æ›¸/04_ä¼šè©±LLM_æ„Ÿæƒ…ãƒ»å¯¾è©±ä»•æ§˜.md:152-208`](../ä»•æ§˜æ›¸/04_ä¼šè©±LLM_æ„Ÿæƒ…ãƒ»å¯¾è©±ä»•æ§˜.md:152)

#### 3.1.1 ã‚¹ã‚¿ã‚¤ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç®¡ç†

**6ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**ï¼ˆ0.0 ï½ 1.0ï¼‰:

```python
{
    "formality": 0.5,      # ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«(0.0) â‡” ãƒ•ã‚©ãƒ¼ãƒãƒ«(1.0)
    "verbosity": 0.5,      # ç°¡æ½”(0.0) â‡” è©³ç´°(1.0)
    "humor": 0.5,          # çœŸé¢ç›®(0.0) â‡” ãƒ¦ãƒ¼ãƒ¢ãƒ©ã‚¹(1.0)
    "technical_level": 0.5,# å¹³æ˜“(0.0) â‡” å°‚é–€çš„(1.0)
    "empathy": 0.7,        # å…±æ„Ÿãƒ¬ãƒ™ãƒ«
    "proactivity": 0.5     # å—å‹•çš„(0.0) â‡” ç©æ¥µçš„(1.0)
}
```

#### 3.1.2 ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å­¦ç¿’

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä¾‹**:
- ğŸ‘ "ã‚‚ã£ã¨è©³ã—ãèª¬æ˜ã—ã¦ã»ã—ã„" â†’ `verbosity += 0.1`
- ğŸ‘ "å°‚é–€ç”¨èªãŒå¤šã™ãã‚‹" â†’ `technical_level -= 0.15`
- ğŸ‘ "ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªæ„Ÿã˜ãŒã„ã„" â†’ `formality -= 0.1`

#### 3.1.3 ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå‹•çš„ç”Ÿæˆ

```python
# ä¾‹: formality=0.8, verbosity=0.3 ã®å ´åˆ
"""
ã‚ãªãŸã¯ä¸å¯§ã§ç°¡æ½”ãªå›ç­”ã‚’å¿ƒãŒã‘ã¾ã™ã€‚
æ•¬èªã‚’ä½¿ç”¨ã—ã€è¦ç‚¹ã‚’çµã£ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
"""

# ä¾‹: formality=0.2, humor=0.8 ã®å ´åˆ
"""
ã‚ãªãŸã¯ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§ãƒ¦ãƒ¼ãƒ¢ã‚¢ã®ã‚ã‚‹ä¼šè©±ã‚’å¿ƒãŒã‘ã¾ã™ã€‚
è»½ã„ã‚¸ãƒ§ãƒ¼ã‚¯ã‚’äº¤ãˆãªãŒã‚‰ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸé›°å›²æ°—ã§è©±ã—ã¦ãã ã•ã„ã€‚
"""
```

### 3.2 ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

#### core/dialogue_style.py (250è¡Œ)

```python
"""å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«å‹•çš„èª¿æ•´ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«."""

from typing import Dict, Any
import json


class AdaptiveDialogueStyle:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«é©å¿œã‚¯ãƒ©ã‚¹."""
    
    def __init__(self, user_id: str):
        """
        åˆæœŸåŒ–.
        
        Args:
            user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
        """
        self.user_id = user_id
        self.parameters = {
            "formality": 0.5,
            "verbosity": 0.5,
            "humor": 0.5,
            "technical_level": 0.5,
            "empathy": 0.7,
            "proactivity": 0.5
        }
        self._load_from_profile()
    
    def learn_from_feedback(self, user_feedback: Dict[str, Any]) -> None:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‹ã‚‰å­¦ç¿’.
        
        Args:
            user_feedback: {
                "message": "ã‚‚ã£ã¨è©³ã—ãèª¬æ˜ã—ã¦ã»ã—ã„",
                "thumbs_up": True,
                "specific_feedback": {"verbosity": "+"}
            }
        """
        if user_feedback.get("specific_feedback"):
            for param, direction in user_feedback["specific_feedback"].items():
                if direction == "+":
                    self.parameters[param] = min(1.0, self.parameters[param] + 0.1)
                elif direction == "-":
                    self.parameters[param] = max(0.0, self.parameters[param] - 0.1)
        
        # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã®è‡ªå‹•æ¨è«–
        message = user_feedback.get("message", "").lower()
        if "è©³ã—" in message or "detail" in message:
            self.parameters["verbosity"] = min(1.0, self.parameters["verbosity"] + 0.15)
        if "ç°¡æ½”" in message or "brief" in message:
            self.parameters["verbosity"] = max(0.0, self.parameters["verbosity"] - 0.15)
        if "å°‚é–€" in message or "technical" in message:
            self.parameters["technical_level"] = min(1.0, self.parameters["technical_level"] + 0.15)
        if "ã‚ã‹ã‚Šã‚„ã™ã" in message or "simple" in message:
            self.parameters["technical_level"] = max(0.0, self.parameters["technical_level"] - 0.15)
        
        self._save_to_profile()
    
    def generate_style_prompt(self) -> str:
        """
        ã‚¹ã‚¿ã‚¤ãƒ«ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿®é£¾å­ç”Ÿæˆ.
        
        Returns:
            str: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿®é£¾å­
        """
        prompt_parts = []
        
        # Formality
        if self.parameters["formality"] > 0.7:
            prompt_parts.append("ä¸å¯§ã§ç¤¼å„€æ­£ã—ã„è¨€è‘‰é£ã„ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚")
        elif self.parameters["formality"] < 0.3:
            prompt_parts.append("ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªè¨€è‘‰é£ã„ã§è©±ã—ã¦ãã ã•ã„ã€‚")
        
        # Verbosity
        if self.parameters["verbosity"] > 0.7:
            prompt_parts.append("è©³ç´°ãªèª¬æ˜ã¨å…·ä½“ä¾‹ã‚’å¤šãå«ã‚ã¦ãã ã•ã„ã€‚")
        elif self.parameters["verbosity"] < 0.3:
            prompt_parts.append("ç°¡æ½”ã§è¦ç‚¹ã‚’çµã£ãŸå›ç­”ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚")
        
        # Humor
        if self.parameters["humor"] > 0.7:
            prompt_parts.append("é©åº¦ã«ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’äº¤ãˆã€æ¥½ã—ã„é›°å›²æ°—ã§è©±ã—ã¦ãã ã•ã„ã€‚")
        elif self.parameters["humor"] < 0.3:
            prompt_parts.append("çœŸé¢ç›®ã§èª å®Ÿãªãƒˆãƒ¼ãƒ³ã‚’ä¿ã£ã¦ãã ã•ã„ã€‚")
        
        # Technical Level
        if self.parameters["technical_level"] > 0.7:
            prompt_parts.append("å°‚é–€ç”¨èªã‚„æŠ€è¡“çš„ãªè©³ç´°ã‚’å«ã‚ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚")
        elif self.parameters["technical_level"] < 0.3:
            prompt_parts.append("å¹³æ˜“ãªè¨€è‘‰ã§ã€èª°ã«ã§ã‚‚ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚")
        
        # Empathy
        if self.parameters["empathy"] > 0.7:
            prompt_parts.append("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„Ÿæƒ…ã«å¯„ã‚Šæ·»ã„ã€å…±æ„Ÿçš„ãªæ…‹åº¦ã‚’ç¤ºã—ã¦ãã ã•ã„ã€‚")
        
        # Proactivity
        if self.parameters["proactivity"] > 0.7:
            prompt_parts.append("ç©æ¥µçš„ã«ææ¡ˆã‚„è¿½åŠ æƒ…å ±ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚")
        elif self.parameters["proactivity"] < 0.3:
            prompt_parts.append("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã—ã¦ã®ã¿å›ç­”ã—ã¦ãã ã•ã„ã€‚")
        
        return "\n".join(prompt_parts)
    
    def _load_from_profile(self) -> None:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿."""
        try:
            with open(f"profiles/{self.user_id}_style.json", "r") as f:
                saved_params = json.load(f)
                self.parameters.update(saved_params)
        except FileNotFoundError:
            pass
    
    def _save_to_profile(self) -> None:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜."""
        import os
        os.makedirs("profiles", exist_ok=True)
        with open(f"profiles/{self.user_id}_style.json", "w") as f:
            json.dump(self.parameters, f, indent=2)
```

### 3.3 ãƒ†ã‚¹ãƒˆï¼ˆ12ä»¶ï¼‰

#### tests/test_dialogue_style.py

```python
"""å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«é©å¿œãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ†ã‚¹ãƒˆ."""

import pytest
from core.dialogue_style import AdaptiveDialogueStyle


def test_style_init():
    """åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ."""
    style = AdaptiveDialogueStyle("user_001")
    assert style.user_id == "user_001"
    assert style.parameters["formality"] == 0.5
    assert style.parameters["empathy"] == 0.7


def test_learn_from_feedback():
    """ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å­¦ç¿’ãƒ†ã‚¹ãƒˆ."""
    style = AdaptiveDialogueStyle("user_002")
    
    # è©³ç´°å¸Œæœ›ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    style.learn_from_feedback({
        "message": "ã‚‚ã£ã¨è©³ã—ãèª¬æ˜ã—ã¦ã»ã—ã„",
        "thumbs_up": True
    })
    assert style.parameters["verbosity"] > 0.5
    
    # å°‚é–€ç”¨èªå¤šã™ãã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    style.learn_from_feedback({
        "message": "å°‚é–€ç”¨èªãŒå¤šã™ãã‚‹",
        "thumbs_up": False
    })
    # Note: ç¾åœ¨ã®å®Ÿè£…ã§ã¯"å°‚é–€"ã¯å¢—åŠ æ–¹å‘ãªã®ã§ã€åˆ¥ãƒ­ã‚¸ãƒƒã‚¯å¿…è¦


def test_generate_style_prompt():
    """ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ†ã‚¹ãƒˆ."""
    style = AdaptiveDialogueStyle("user_003")
    
    # ãƒ•ã‚©ãƒ¼ãƒãƒ«ãƒ»è©³ç´°
    style.parameters["formality"] = 0.8
    style.parameters["verbosity"] = 0.8
    prompt = style.generate_style_prompt()
    assert "ä¸å¯§" in prompt
    assert "è©³ç´°" in prompt
    
    # ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ»ç°¡æ½”
    style.parameters["formality"] = 0.2
    style.parameters["verbosity"] = 0.2
    prompt = style.generate_style_prompt()
    assert "ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼" in prompt or "ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«" in prompt
    assert "ç°¡æ½”" in prompt


def test_parameter_bounds():
    """ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¢ƒç•Œãƒ†ã‚¹ãƒˆ."""
    style = AdaptiveDialogueStyle("user_004")
    
    # ä¸Šé™ãƒã‚§ãƒƒã‚¯
    for _ in range(20):
        style.learn_from_feedback({"message": "è©³ã—ã", "thumbs_up": True})
    assert style.parameters["verbosity"] <= 1.0
    
    # ä¸‹é™ãƒã‚§ãƒƒã‚¯
    style.parameters["verbosity"] = 0.0
    for _ in range(20):
        style.learn_from_feedback({"message": "ç°¡æ½”ã«", "thumbs_up": True})
    assert style.parameters["verbosity"] >= 0.0


def test_save_and_load():
    """ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ."""
    style1 = AdaptiveDialogueStyle("user_005")
    style1.parameters["formality"] = 0.9
    style1._save_to_profile()
    
    style2 = AdaptiveDialogueStyle("user_005")
    assert style2.parameters["formality"] == 0.9


# ... ä»–7ä»¶ï¼ˆå¢ƒç•Œå€¤ã€ç•°å¸¸ç³»ã€çµ±åˆãƒ†ã‚¹ãƒˆï¼‰
```

---

## 4. Week 3-4: è‡ªå·±çœå¯Ÿãƒ»ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯

### 4.1 å®Ÿè£…å†…å®¹

**å‚ç…§**: [`docks/ä»•æ§˜æ›¸/04_ä¼šè©±LLM_æ„Ÿæƒ…ãƒ»å¯¾è©±ä»•æ§˜.md:230-536`](../ä»•æ§˜æ›¸/04_ä¼šè©±LLM_æ„Ÿæƒ…ãƒ»å¯¾è©±ä»•æ§˜.md:230)

#### 4.1.1 è‡ªå·±çœå¯Ÿï¼ˆReflectionï¼‰

**ç›®çš„**: ä¼šè©±çµ‚äº†å¾Œã®æŒ¯ã‚Šè¿”ã‚Šã¨å­¦ç¿’

```python
# çœå¯Ÿä¾‹
{
    "timestamp": "2025-11-20T15:30:00Z",
    "session_id": "sess_001",
    "reflection": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ©Ÿæ¢°å­¦ç¿’ã«ã¤ã„ã¦åˆå¿ƒè€…ã ã£ãŸã€‚å°‚é–€ç”¨èªã‚’å¤šç”¨ã—ã™ããŸã€‚æ¬¡å›ã¯å¹³æ˜“ãªè¨€è‘‰ã§èª¬æ˜ã™ã¹ãã€‚",
    "lessons_learned": [
        "technical_level ã‚’ä¸‹ã’ã‚‹",
        "å…·ä½“ä¾‹ã‚’å¤šç”¨ã™ã‚‹"
    ],
    "improvement_areas": ["èª¬æ˜ã®å¹³æ˜“åŒ–", "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ™ãƒ«æ¨å®šç²¾åº¦å‘ä¸Š"]
}
```

#### 4.1.2 çŸ›ç›¾æ¤œå‡ºï¼ˆContradiction Detectionï¼‰

**ç›®çš„**: éå»ç™ºè¨€ã¨ã®ä¸€è²«æ€§ç¶­æŒ

```python
# çŸ›ç›¾æ¤œå‡ºä¾‹
{
    "new_statement": "ç§ã¯çŒ«ãŒå¥½ãã§ã™",
    "contradictory_past_statement": {
        "content": "ç§ã¯çŒ«ãŒè‹¦æ‰‹ã§ã™",
        "timestamp": "2025-11-15T10:00:00Z",
        "session_id": "sess_old_001"
    },
    "contradiction_detected": True,
    "clarification": "ä»¥å‰ã€ŒçŒ«ãŒè‹¦æ‰‹ã€ã¨ãŠã£ã—ã‚ƒã£ã¦ã„ã¾ã—ãŸãŒã€æœ€è¿‘ã¯çŒ«ãŒãŠå¥½ãã«ãªã‚‰ã‚ŒãŸã®ã§ã™ã‹ï¼Ÿ"
}
```

#### 4.1.3 ãƒˆãƒ”ãƒƒã‚¯è¿½è·¡ï¼ˆTopic Trackingï¼‰

**ç›®çš„**: è©±é¡Œã®æµã‚Œç®¡ç†ã¨è‡ªç„¶ãªè»¢æ›

```python
# ãƒˆãƒ”ãƒƒã‚¯å±¥æ­´ä¾‹
{
    "topic_history": [
        {"topic": "æ©Ÿæ¢°å­¦ç¿’", "start": 1, "end": 5, "duration": 5},
        {"topic": "Python", "start": 6, "end": 10, "duration": 5},
        {"topic": "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹", "start": 11, "end": None, "duration": None}
    ],
    "current_topic": "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹",
    "shift_detected": True,
    "transition_phrase": "Pythonã®è©±ã‹ã‚‰ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¤ã„ã¦ãŠè©±ã—ã¾ã—ã‚‡ã†ã‹ã€‚"
}
```

### 4.2 ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

#### core/self_reflection.py (300è¡Œ)

```python
"""è‡ªå·±çœå¯Ÿãƒ»ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«."""

from typing import Dict, List, Any, Optional
from datetime import datetime
import json
from memory.long_term import LongTermMemory


class SelfReflection:
    """è‡ªå·±çœå¯Ÿã‚¯ãƒ©ã‚¹."""
    
    def __init__(self, character_name: str):
        """
        åˆæœŸåŒ–.
        
        Args:
            character_name: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å
        """
        self.character_name = character_name
        self.long_term_memory = LongTermMemory()
    
    def reflect_on_conversation(self, conversation_history: List[Dict[str, Any]]) -> Dict[str, Any]:
        """
        ä¼šè©±æŒ¯ã‚Šè¿”ã‚Š.
        
        Args:
            conversation_history: ä¼šè©±å±¥æ­´
        
        Returns:
            Dict: çœå¯Ÿçµæœ
        """
        reflection = {
            "timestamp": datetime.utcnow().isoformat(),
            "session_id": conversation_history[0].get("session_id"),
            "reflection": "",
            "lessons_learned": [],
            "improvement_areas": []
        }
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã‹ã‚‰ãƒ‘ã‚¿ãƒ¼ãƒ³æŠ½å‡º
        user_messages = [msg for msg in conversation_history if msg["role"] == "user"]
        if not user_messages:
            return reflection
        
        # åˆ†æä¾‹ï¼ˆå®Ÿéš›ã¯LLMã§ç”Ÿæˆï¼‰
        reflection["reflection"] = f"{len(user_messages)}å›ã®ã‚„ã‚Šå–ã‚ŠãŒã‚ã‚Šã¾ã—ãŸã€‚"
        
        # å­¦ã³ã®æŠ½å‡º
        if any("ã‚ã‹ã‚Šã‚„ã™ã" in msg.get("content", "") for msg in user_messages):
            reflection["lessons_learned"].append("technical_level ã‚’ä¸‹ã’ã‚‹")
        
        if any("è©³ã—ã" in msg.get("content", "") for msg in user_messages):
            reflection["lessons_learned"].append("verbosity ã‚’ä¸Šã’ã‚‹")
        
        self._store_reflection(reflection)
        return reflection
    
    def _store_reflection(self, reflection: Dict[str, Any]) -> None:
        """çœå¯Ÿã‚’é•·æœŸè¨˜æ†¶ã«ä¿å­˜."""
        self.long_term_memory.store(
            content=json.dumps(reflection, ensure_ascii=False),
            category="reflection",
            metadata={"character": self.character_name}
        )
    
    def retrieve_past_lessons(self, current_situation: str) -> List[Dict[str, Any]]:
        """
        éå»ã®å­¦ã³ã‚’æ¤œç´¢.
        
        Args:
            current_situation: ç¾åœ¨ã®çŠ¶æ³ï¼ˆä¾‹: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ€è¡“çš„ãªè³ªå•ã‚’ã—ã¦ã„ã‚‹"ï¼‰
        
        Returns:
            List[Dict]: é–¢é€£ã™ã‚‹éå»ã®å­¦ã³
        """
        results = self.long_term_memory.search(
            query=current_situation,
            top_k=5,
            filter_dict={"category": "reflection"}
        )
        
        lessons = []
        for result in results:
            try:
                reflection = json.loads(result["content"])
                lessons.append(reflection)
            except json.JSONDecodeError:
                continue
        
        return lessons


class DialogueCoherence:
    """å¯¾è©±ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯ã‚¯ãƒ©ã‚¹."""
    
    def __init__(self):
        """åˆæœŸåŒ–."""
        self.long_term_memory = LongTermMemory()
    
    def check_consistency(
        self,
        new_statement: str,
        history: List[Dict[str, Any]],
        threshold: float = 0.7
    ) -> Dict[str, Any]:
        """
        ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯.
        
        Args:
            new_statement: æ–°ã—ã„ç™ºè¨€
            history: ä¼šè©±å±¥æ­´
            threshold: çŸ›ç›¾æ¤œå‡ºé–¾å€¤
        
        Returns:
            Dict: ãƒã‚§ãƒƒã‚¯çµæœ
        """
        result = {
            "contradiction_detected": False,
            "contradictory_past_statement": None,
            "clarification": None
        }
        
        # éå»ç™ºè¨€ã‹ã‚‰é¡ä¼¼ãƒˆãƒ”ãƒƒã‚¯æ¤œç´¢
        past_statements = self.long_term_memory.search(
            query=new_statement,
            top_k=10
        )
        
        for past in past_statements:
            if self._detect_contradiction(new_statement, past["content"]):
                result["contradiction_detected"] = True
                result["contradictory_past_statement"] = past
                result["clarification"] = self._generate_clarification(
                    new_statement,
                    past["content"]
                )
                break
        
        return result
    
    def _detect_contradiction(self, stmt1: str, stmt2: str) -> bool:
        """
        çŸ›ç›¾æ¤œå‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰.
        
        å®Ÿéš›ã¯LLMã¾ãŸã¯NLIï¼ˆNatural Language Inferenceï¼‰ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨.
        """
        # ç°¡æ˜“å®Ÿè£…ä¾‹
        negation_patterns = [
            ("å¥½ã", "è‹¦æ‰‹"),
            ("å¾—æ„", "è‹¦æ‰‹"),
            ("è³›æˆ", "åå¯¾")
        ]
        
        for pos, neg in negation_patterns:
            if (pos in stmt1 and neg in stmt2) or (neg in stmt1 and pos in stmt2):
                return True
        
        return False
    
    def _generate_clarification(self, new_stmt: str, past_stmt: str) -> str:
        """
        çŸ›ç›¾ã«å¯¾ã™ã‚‹æ˜ç¢ºåŒ–è³ªå•ç”Ÿæˆ.
        
        Args:
            new_stmt: æ–°ç™ºè¨€
            past_stmt: éå»ç™ºè¨€
        
        Returns:
            str: æ˜ç¢ºåŒ–è³ªå•
        """
        return f"ä»¥å‰ã€Œ{past_stmt}ã€ã¨ãŠã£ã—ã‚ƒã£ã¦ã„ã¾ã—ãŸãŒã€ä»Šå›ã¯ã€Œ{new_stmt}ã€ã¨ã®ã“ã¨ã€‚ãŠè€ƒãˆãŒå¤‰ã‚ã‚‰ã‚ŒãŸã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ"


class TopicTracker:
    """ãƒˆãƒ”ãƒƒã‚¯è¿½è·¡ã‚¯ãƒ©ã‚¹."""
    
    def __init__(self):
        """åˆæœŸåŒ–."""
        self.topic_history: List[Dict[str, Any]] = []
        self.current_topic: Optional[str] = None
        self.message_count = 0
    
    def detect_topic_shift(
        self,
        user_input: str,
        context: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        è©±é¡Œè»¢æ›æ¤œå‡º.
        
        Args:
            user_input: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
            context: æ–‡è„ˆæƒ…å ±
        
        Returns:
            Dict: æ¤œå‡ºçµæœ
        """
        self.message_count += 1
        
        # ãƒˆãƒ”ãƒƒã‚¯æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆã€å®Ÿéš›ã¯LLMã§æŠ½å‡ºï¼‰
        new_topic = self._extract_topic(user_input)
        
        shift_detected = False
        if self.current_topic and new_topic != self.current_topic:
            shift_detected = True
            # ç¾åœ¨ã®ãƒˆãƒ”ãƒƒã‚¯çµ‚äº†
            if self.topic_history:
                self.topic_history[-1]["end"] = self.message_count - 1
                self.topic_history[-1]["duration"] = (
                    self.topic_history[-1]["end"] - self.topic_history[-1]["start"] + 1
                )
        
        if shift_detected or self.current_topic is None:
            self.current_topic = new_topic
            self.topic_history.append({
                "topic": new_topic,
                "start": self.message_count,
                "end": None,
                "duration": None
            })
        
        return {
            "shift_detected": shift_detected,
            "current_topic": self.current_topic,
            "topic_history": self.topic_history
        }
    
    def generate_transition_phrase(self, old_topic: str, new_topic: str) -> str:
        """
        è©±é¡Œè»¢æ›ãƒ•ãƒ¬ãƒ¼ã‚ºç”Ÿæˆ.
        
        Args:
            old_topic: æ—§ãƒˆãƒ”ãƒƒã‚¯
            new_topic: æ–°ãƒˆãƒ”ãƒƒã‚¯
        
        Returns:
            str: è»¢æ›ãƒ•ãƒ¬ãƒ¼ã‚º
        """
        return f"{old_topic}ã®è©±ã‹ã‚‰ã€{new_topic}ã«ã¤ã„ã¦ãŠè©±ã—ã¾ã—ã‚‡ã†ã‹ã€‚"
    
    def suggest_topic_return(self) -> Optional[str]:
        """
        ä»¥å‰ã®ãƒˆãƒ”ãƒƒã‚¯ã¸ã®æˆ»ã‚Šææ¡ˆ.
        
        Returns:
            Optional[str]: ææ¡ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        """
        if len(self.topic_history) < 2:
            return None
        
        previous_topic = self.topic_history[-2]["topic"]
        return f"å…ˆã»ã©ã®{previous_topic}ã®è©±é¡Œã«æˆ»ã‚Šã¾ã—ã‚‡ã†ã‹ï¼Ÿ"
    
    def _extract_topic(self, text: str) -> str:
        """
        ãƒˆãƒ”ãƒƒã‚¯æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰.
        
        å®Ÿéš›ã¯LLMã¾ãŸã¯ãƒˆãƒ”ãƒƒã‚¯ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨.
        """
        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ç°¡æ˜“å®Ÿè£…
        keywords = {
            "æ©Ÿæ¢°å­¦ç¿’": ["æ©Ÿæ¢°å­¦ç¿’", "ML", "ãƒ¢ãƒ‡ãƒ«"],
            "Python": ["Python", "ãƒ‘ã‚¤ã‚½ãƒ³", "ã‚³ãƒ¼ãƒ‰"],
            "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹": ["ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹", "DB", "SQL"]
        }
        
        for topic, kws in keywords.items():
            if any(kw in text for kw in kws):
                return topic
        
        return "ãã®ä»–"
```

### 4.3 ãƒ†ã‚¹ãƒˆï¼ˆ18ä»¶ï¼‰

#### tests/test_self_reflection.py

```python
"""è‡ªå·±çœå¯Ÿãƒ»ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ†ã‚¹ãƒˆ."""

import pytest
from core.self_reflection import SelfReflection, DialogueCoherence, TopicTracker


def test_reflect_on_conversation():
    """çœå¯Ÿãƒ†ã‚¹ãƒˆ."""
    reflection = SelfReflection("lumina")
    
    conversation = [
        {"role": "user", "content": "ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„", "session_id": "sess_001"},
        {"role": "assistant", "content": "æ‰¿çŸ¥ã—ã¾ã—ãŸ", "session_id": "sess_001"}
    ]
    
    result = reflection.reflect_on_conversation(conversation)
    assert result["session_id"] == "sess_001"
    assert "technical_level ã‚’ä¸‹ã’ã‚‹" in result["lessons_learned"]


def test_store_reflection():
    """çœå¯Ÿä¿å­˜ãƒ†ã‚¹ãƒˆ."""
    reflection = SelfReflection("clarisse")
    
    conversation = [
        {"role": "user", "content": "è©³ã—ãæ•™ãˆã¦", "session_id": "sess_002"},
        {"role": "assistant", "content": "ã¯ã„", "session_id": "sess_002"}
    ]
    
    result = reflection.reflect_on_conversation(conversation)
    # ä¿å­˜å‡¦ç†ã¯ _store_reflection å†…ã§å®Ÿè¡Œæ¸ˆã¿
    assert result is not None


def test_retrieve_past_lessons():
    """å­¦ã³æ¤œç´¢ãƒ†ã‚¹ãƒˆ."""
    reflection = SelfReflection("lumina")
    
    lessons = reflection.retrieve_past_lessons("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ€è¡“çš„ãªè³ªå•ã‚’ã—ã¦ã„ã‚‹")
    assert isinstance(lessons, list)


def test_check_consistency():
    """ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ."""
    coherence = DialogueCoherence()
    
    history = [
        {"role": "assistant", "content": "ç§ã¯çŒ«ãŒè‹¦æ‰‹ã§ã™"}
    ]
    
    result = coherence.check_consistency("ç§ã¯çŒ«ãŒå¥½ãã§ã™", history)
    # Note: å®Ÿéš›ã¯é•·æœŸè¨˜æ†¶ã«ä¿å­˜ã•ã‚ŒãŸã‚‚ã®ã‚’æ¤œç´¢ã™ã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯æ¤œå‡ºã•ã‚Œãªã„å¯èƒ½æ€§


def test_detect_contradiction():
    """çŸ›ç›¾æ¤œå‡ºãƒ†ã‚¹ãƒˆ."""
    coherence = DialogueCoherence()
    
    # çŸ›ç›¾ã‚ã‚Š
    assert coherence._detect_contradiction("ç§ã¯çŒ«ãŒå¥½ãã§ã™", "ç§ã¯çŒ«ãŒè‹¦æ‰‹ã§ã™")
    
    # çŸ›ç›¾ãªã—
    assert not coherence._detect_contradiction("ç§ã¯çŒ«ãŒå¥½ãã§ã™", "ç§ã¯çŠ¬ã‚‚å¥½ãã§ã™")


def test_topic_shift_detection():
    """è©±é¡Œè»¢æ›æ¤œå‡ºãƒ†ã‚¹ãƒˆ."""
    tracker = TopicTracker()
    
    # åˆå›
    result1 = tracker.detect_topic_shift("æ©Ÿæ¢°å­¦ç¿’ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„", {})
    assert result1["shift_detected"] is False
    assert result1["current_topic"] == "æ©Ÿæ¢°å­¦ç¿’"
    
    # åŒã˜ãƒˆãƒ”ãƒƒã‚¯
    result2 = tracker.detect_topic_shift("æ©Ÿæ¢°å­¦ç¿’ã®ãƒ¢ãƒ‡ãƒ«ã¯ï¼Ÿ", {})
    assert result2["shift_detected"] is False
    
    # ãƒˆãƒ”ãƒƒã‚¯è»¢æ›
    result3 = tracker.detect_topic_shift("Pythonã®ã‚³ãƒ¼ãƒ‰ã‚’æ•™ãˆã¦", {})
    assert result3["shift_detected"] is True
    assert result3["current_topic"] == "Python"


def test_transition_phrase():
    """è»¢æ›ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ†ã‚¹ãƒˆ."""
    tracker = TopicTracker()
    
    phrase = tracker.generate_transition_phrase("æ©Ÿæ¢°å­¦ç¿’", "Python")
    assert "æ©Ÿæ¢°å­¦ç¿’" in phrase
    assert "Python" in phrase


# ... ä»–11ä»¶ï¼ˆå¢ƒç•Œå€¤ã€ç•°å¸¸ç³»ã€çµ±åˆãƒ†ã‚¹ãƒˆï¼‰
```

---

## 5. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### 5.1 Pythonä¾å­˜

```txt
# requirements.txt ã«è¿½åŠ 
textblob==0.17.1        # ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ†æï¼ˆæ„Ÿæƒ…æ¨è«–ç”¨ï¼‰
scikit-learn==1.3.0     # ãƒˆãƒ”ãƒƒã‚¯æŠ½å‡ºãƒ»é¡ä¼¼åº¦è¨ˆç®—
```

### 5.2 æ–°è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

- **core/dialogue_style.py**: å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«é©å¿œ
- **core/self_reflection.py**: è‡ªå·±çœå¯Ÿãƒ»ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯

---

## 6. ãƒ†ã‚¹ãƒˆè¨ˆç”»

### 6.1 ãƒ†ã‚¹ãƒˆæ§‹æˆ

| ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« | ãƒ†ã‚¹ãƒˆä»¶æ•° | ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™ |
|---------------|-----------|---------------|
| `tests/test_dialogue_style.py` | 12ä»¶ | > 90% |
| `tests/test_self_reflection.py` | 18ä»¶ | > 85% |
| **åˆè¨ˆ** | **30ä»¶** | **> 88%** |

### 6.2 ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒª

**Unit Testsï¼ˆ20ä»¶ï¼‰**:
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ
- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å­¦ç¿’ãƒ†ã‚¹ãƒˆ
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ†ã‚¹ãƒˆ
- çŸ›ç›¾æ¤œå‡ºãƒ†ã‚¹ãƒˆ
- ãƒˆãƒ”ãƒƒã‚¯è¿½è·¡ãƒ†ã‚¹ãƒˆ

**Integration Testsï¼ˆ10ä»¶ï¼‰**:
- é•·æœŸè¨˜æ†¶ã¨ã®é€£æºãƒ†ã‚¹ãƒˆ
- æ„Ÿæƒ…ãƒ¢ãƒ‡ãƒ«ã¨ã®é€£æºãƒ†ã‚¹ãƒˆ
- APIçµ±åˆãƒ†ã‚¹ãƒˆ

### 6.3 å®Ÿè¡Œæ–¹æ³•

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest tests/test_dialogue_style.py tests/test_self_reflection.py -v

# ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬
pytest --cov=core --cov-report=html tests/
```

---

## 7. æˆæœç‰©

### 7.1 å®Ÿè£…ã‚³ãƒ¼ãƒ‰

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**:
- `core/dialogue_style.py` (250è¡Œ)
- `core/self_reflection.py` (300è¡Œ)
- **åˆè¨ˆ**: 550è¡Œ

### 7.2 ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**:
- `tests/test_dialogue_style.py` (12ä»¶)
- `tests/test_self_reflection.py` (18ä»¶)
- **åˆè¨ˆ**: 30ä»¶

### 7.3 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `docks/å®Œäº†å ±å‘Š/Phase5_å®Œäº†ã‚µãƒãƒªãƒ¼.md`
- APIä»•æ§˜æ›¸æ›´æ–°

### 7.4 ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³

- [ ] å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«é©å¿œå‹•ä½œç¢ºèª
- [ ] è‡ªå·±çœå¯Ÿãƒ»çŸ›ç›¾æ¤œå‡ºãƒ†ã‚¹ãƒˆæˆåŠŸ
- [ ] ãƒˆãƒ”ãƒƒã‚¯è¿½è·¡ç²¾åº¦ > 80%
- [ ] å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆ30ä»¶ï¼‰
- [ ] ã‚«ãƒãƒ¬ãƒƒã‚¸ > 88%

---

**Phase 5 å®Ÿè£…å®Œäº†**: ãƒ¦ãƒ¼ã‚¶ãƒ¼é©å¿œå‹å¯¾è©±ã‚·ã‚¹ãƒ†ãƒ ã®åŸºç›¤ãŒæ•´ã„ã¾ã—ãŸã€‚