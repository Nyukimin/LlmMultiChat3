# LlmMultiChat3 デプロイガイド

**バージョン**: 1.0  
**対象**: Phase 2完了版  
**最終更新**: 2025-11-13

---

## 目次

1. [システム要件](#1-システム要件)
2. [環境構築](#2-環境構築)
3. [Redis設定](#3-redis設定)
4. [アプリケーション設定](#4-アプリケーション設定)
5. [デプロイ手順](#5-デプロイ手順)
6. [監視・ログ設定](#6-監視ログ設定)
7. [トラブルシューティング](#7-トラブルシューティング)
8. [セキュリティチェックリスト](#8-セキュリティチェックリスト)

---

## 1. システム要件

### 1.1 ハードウェア要件

#### 開発環境
- **CPU**: 2コア以上
- **メモリ**: 4GB以上
- **ストレージ**: 10GB以上（ログ・キャッシュ含む）

#### 本番環境
- **CPU**: 4コア以上（推奨: 8コア）
- **メモリ**: 8GB以上（推奨: 16GB）
- **ストレージ**: 50GB以上（推奨: SSD）
- **ネットワーク**: 100Mbps以上

### 1.2 ソフトウェア要件

| ソフトウェア | バージョン | 用途 |
|------------|-----------|------|
| Python | 3.10.0+ | アプリケーション実行 |
| pip | 23.0.0+ | パッケージ管理 |
| Redis | 7.0.0+ | 中期記憶キャッシュ |
| Ollama | 0.1.0+ | ローカルLLM実行 |
| Git | 2.30.0+ | バージョン管理 |

### 1.3 対応OS

- ✅ **Ubuntu**: 20.04 LTS / 22.04 LTS
- ✅ **CentOS**: 8 / 9
- ✅ **Windows**: 10 / 11（開発環境のみ）
- ✅ **macOS**: 12.0+

---

## 2. 環境構築

### 2.1 リポジトリクローン

```bash
# HTTPS
git clone https://github.com/your-org/LlmMultiChat3.git
cd LlmMultiChat3

# または SSH
git clone git@github.com:your-org/LlmMultiChat3.git
cd LlmMultiChat3
```

### 2.2 Python仮想環境作成

#### Linux/macOS
```bash
python3 -m venv venv
source venv/bin/activate
```

#### Windows
```powershell
python -m venv venv
.\venv\Scripts\activate
```

### 2.3 依存関係インストール

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

#### requirements.txt (Phase 2版)
```txt
langchain>=0.1.0
langgraph>=0.0.20
ollama>=0.1.0
duckdb>=0.9.0
redis==7.0.1
pytest>=7.4.3
```

### 2.4 環境変数設定

```bash
# .envファイル作成
cp .env.example .env

# エディタで編集
nano .env  # または vim .env
```

#### .env テンプレート
```bash
# LLM設定
LUMINA_MODEL=llama3.2:1b
GEMINI_MODEL=gemma2:2b
OPENAI_API_KEY=your_openai_api_key_here  # 未使用時は空欄

# Redis設定
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=  # 開発環境では空欄
REDIS_SSL=false  # 本番環境ではtrue推奨

# アプリケーション設定
LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR
MAX_RETRIES=3
TIMEOUT_SECONDS=30
CACHE_TTL_HOURS=24

# セキュリティ設定
ALLOWED_COMMANDS=ls,pwd,echo,cat,grep,find,wc,head,tail
MAX_INPUT_LENGTH=10000
SESSION_ID_MAX_LENGTH=100
```

---

## 3. Redis設定

### 3.1 Redisインストール

#### Ubuntu/Debian
```bash
sudo apt update
sudo apt install redis-server -y
```

#### CentOS/RHEL
```bash
sudo yum install redis -y
```

#### macOS (Homebrew)
```bash
brew install redis
```

#### Windows
```powershell
# WSL2経由でインストール推奨
wsl --install
wsl -d Ubuntu
sudo apt update && sudo apt install redis-server -y
```

### 3.2 Redis起動

#### システムサービスとして起動（Linux）
```bash
sudo systemctl start redis
sudo systemctl enable redis  # 自動起動設定
sudo systemctl status redis  # 状態確認
```

#### 手動起動
```bash
redis-server --daemonize yes
```

#### 起動確認
```bash
redis-cli ping
# 応答: PONG
```

### 3.3 Redis設定ファイル（本番環境）

`/etc/redis/redis.conf` を編集:

```conf
# ネットワーク設定
bind 127.0.0.1  # ローカルのみ許可（本番環境では必須）
protected-mode yes
port 6379

# パスワード認証（本番環境では必須）
requirepass your_strong_password_here

# メモリ設定
maxmemory 2gb
maxmemory-policy allkeys-lru  # LRU削除

# 永続化設定
save 900 1      # 15分間に1回変更があれば保存
save 300 10     # 5分間に10回変更があれば保存
save 60 10000   # 1分間に10000回変更があれば保存

# ログ設定
loglevel notice
logfile /var/log/redis/redis-server.log

# TLS設定（本番環境推奨）
# tls-port 6380
# tls-cert-file /path/to/redis.crt
# tls-key-file /path/to/redis.key
# tls-ca-cert-file /path/to/ca.crt
```

### 3.4 TLS接続設定（本番環境推奨）

#### 証明書生成
```bash
# 自己署名証明書（開発環境用）
openssl req -x509 -newkey rsa:4096 -keyout redis.key -out redis.crt -days 365 -nodes

# Let's Encrypt（本番環境推奨）
sudo certbot certonly --standalone -d redis.yourdomain.com
```

#### .env更新
```bash
REDIS_SSL=true
REDIS_TLS_CERT=/path/to/redis.crt
REDIS_TLS_KEY=/path/to/redis.key
```

---

## 4. アプリケーション設定

### 4.1 ディレクトリ構造確認

```
LlmMultiChat3/
├── main.py              # メインアプリケーション
├── config.py            # 設定管理
├── llm_nodes.py         # LLMノード
├── memory_manager.py    # 記憶マネージャー
├── exceptions.py        # カスタム例外
├── validators.py        # 入力検証
├── metrics.py           # メトリクス収集
├── dashboard.py         # 簡易ダッシュボード
├── utils.py             # ユーティリティ
├── memory/
│   ├── __init__.py
│   ├── base.py
│   ├── short_term.py
│   ├── mid_term.py
│   ├── long_term.py
│   ├── knowledge_base.py
│   └── redis_cache.py   # Redisキャッシュ
├── data/                # データディレクトリ（自動作成）
│   ├── short_term.db
│   ├── mid_term.db
│   └── long_term.db
├── logs/                # ログディレクトリ（自動作成）
│   ├── error.log
│   └── error.log.1
└── docks/               # ドキュメント
```

### 4.2 データディレクトリ作成

```bash
# 自動作成されるが、権限確認のため手動作成推奨
mkdir -p data logs
chmod 750 data logs
```

### 4.3 システムチェック

```bash
python check_system.py
```

**期待される出力**:
```
✅ Python 3.10.0+
✅ Redis接続成功
✅ Ollama接続成功
✅ 依存関係インストール済み
✅ ディレクトリ権限正常
```

---

## 5. デプロイ手順

### 5.1 開発環境デプロイ

```bash
# 1. 環境構築
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 2. 環境変数設定
cp .env.example .env
nano .env  # 必要に応じて編集

# 3. Redis起動
redis-server --daemonize yes

# 4. アプリケーション起動
python main.py

# 5. テスト実行
pytest test_week5.py test_week6.py test_week7.py -v
```

### 5.2 本番環境デプロイ（systemdサービス）

#### 5.2.1 サービスファイル作成

`/etc/systemd/system/llmmultichat3.service`:

```ini
[Unit]
Description=LlmMultiChat3 Service
After=network.target redis.service
Requires=redis.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/LlmMultiChat3
Environment="PATH=/opt/LlmMultiChat3/venv/bin"
ExecStart=/opt/LlmMultiChat3/venv/bin/python main.py
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

# セキュリティ設定
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/LlmMultiChat3/data /opt/LlmMultiChat3/logs

[Install]
WantedBy=multi-user.target
```

#### 5.2.2 サービス有効化

```bash
# サービスファイルリロード
sudo systemctl daemon-reload

# サービス有効化
sudo systemctl enable llmmultichat3.service

# サービス起動
sudo systemctl start llmmultichat3.service

# 状態確認
sudo systemctl status llmmultichat3.service
```

### 5.3 Dockerデプロイ（推奨）

#### 5.3.1 Dockerfile

```dockerfile
FROM python:3.10-slim

WORKDIR /app

# 依存関係インストール
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# アプリケーションコピー
COPY . .

# データディレクトリ作成
RUN mkdir -p data logs && chmod 750 data logs

# 非rootユーザー作成
RUN useradd -m -u 1000 appuser && \
    chown -R appuser:appuser /app
USER appuser

# ポート公開（必要に応じて）
EXPOSE 8000

# ヘルスチェック
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD python -c "import redis; r = redis.Redis(host='redis', port=6379); r.ping()" || exit 1

# 起動コマンド
CMD ["python", "main.py"]
```

#### 5.3.2 docker-compose.yml

```yaml
version: '3.8'

services:
  redis:
    image: redis:7-alpine
    container_name: llmmultichat3-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --requirepass your_strong_password
    restart: unless-stopped
    networks:
      - llmmultichat3-network

  app:
    build: .
    container_name: llmmultichat3-app
    depends_on:
      - redis
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=your_strong_password
      - LOG_LEVEL=INFO
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - llmmultichat3-network

volumes:
  redis_data:

networks:
  llmmultichat3-network:
    driver: bridge
```

#### 5.3.3 Docker起動

```bash
# ビルド
docker-compose build

# 起動
docker-compose up -d

# ログ確認
docker-compose logs -f app

# 停止
docker-compose down
```

---

## 6. 監視・ログ設定

### 6.1 ログローテーション

#### logrotate設定

`/etc/logrotate.d/llmmultichat3`:

```conf
/opt/LlmMultiChat3/logs/*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        systemctl reload llmmultichat3.service > /dev/null 2>&1 || true
    endscript
}
```

### 6.2 メトリクス監視

#### Prometheusエクスポーター（オプション）

```python
# metrics_exporter.py
from prometheus_client import Counter, Histogram, Gauge, start_http_server
import time

# メトリクス定義
llm_call_duration = Histogram('llm_call_duration_seconds', 'LLM call duration')
cache_hit_rate = Gauge('cache_hit_rate', 'Cache hit rate')
error_count = Counter('error_count', 'Error count', ['error_type'])

# エクスポーター起動
start_http_server(9090)

# main.pyで統合
from metrics_exporter import llm_call_duration, cache_hit_rate

@llm_call_duration.time()
def call_llm():
    # ...
```

### 6.3 簡易ダッシュボード

```bash
# ダッシュボード生成
python -c "from dashboard import generate_html_report; generate_html_report('dashboard.html')"

# HTTPサーバー起動（開発環境のみ）
python -m http.server 8000

# ブラウザでアクセス
# http://localhost:8000/dashboard.html
```

### 6.4 アラート設定

#### Slackアラート例

```python
# utils.py に追加
import requests
import json

def send_slack_alert(message: str, level: str = "error"):
    """Slackにアラート送信"""
    webhook_url = os.getenv("SLACK_WEBHOOK_URL")
    if not webhook_url:
        return
    
    color_map = {"error": "danger", "warning": "warning", "info": "good"}
    payload = {
        "attachments": [{
            "color": color_map.get(level, "warning"),
            "text": f"[{level.upper()}] {message}",
            "ts": time.time()
        }]
    }
    
    try:
        requests.post(webhook_url, data=json.dumps(payload))
    except Exception as e:
        print(f"Failed to send Slack alert: {e}")
```

---

## 7. トラブルシューティング

### 7.1 Redis接続エラー

**エラー**: `ConnectionError: Error 111 connecting to localhost:6379. Connection refused.`

**原因**: Redis未起動

**解決策**:
```bash
# Redis起動確認
sudo systemctl status redis

# 起動
sudo systemctl start redis

# ログ確認
sudo tail -f /var/log/redis/redis-server.log
```

### 7.2 メモリ不足エラー

**エラー**: `MemoryError: Redis OOM command not allowed`

**原因**: Redis `maxmemory` 超過

**解決策**:
```bash
# Redis設定確認
redis-cli config get maxmemory

# メモリ増設
redis-cli config set maxmemory 4gb

# LRU削除ポリシー確認
redis-cli config get maxmemory-policy
# 応答: allkeys-lru
```

### 7.3 ログファイル肥大化

**エラー**: ディスク容量不足

**解決策**:
```bash
# ログサイズ確認
du -sh logs/

# 古いログ削除
find logs/ -name "*.log.*" -mtime +30 -delete

# ログローテーション手動実行
sudo logrotate -f /etc/logrotate.d/llmmultichat3
```

### 7.4 入力検証エラー

**エラー**: `InputValidationError: Potential XSS attack detected`

**原因**: ユーザー入力に危険なパターン検出

**解決策**:
```python
# validators.py で許可パターン追加（慎重に）
# 例: <code>タグ許可
xss_patterns = [
    r'<script[^>]*>.*?</script>',
    # r'<code[^>]*>.*?</code>',  # ← 許可（コメントアウト）
]
```

### 7.5 テスト失敗

**エラー**: `FAILED test_redis_integration.py::test_redis_cache_set`

**原因**: Redis未起動

**解決策**:
```bash
# Redisスキップマーカー使用
pytest -m "not redis" test_redis_integration.py

# または Redis起動後再実行
sudo systemctl start redis
pytest test_redis_integration.py -v
```

---

## 8. セキュリティチェックリスト

### 8.1 デプロイ前チェック

- [ ] `.env`ファイルが`.gitignore`に含まれている
- [ ] Redis パスワード設定済み（`requirepass`）
- [ ] Redis TLS有効化（本番環境）
- [ ] ファイアウォール設定（Redis: 6379閉じる）
- [ ] SSH公開鍵認証設定（パスワード認証無効化）
- [ ] アプリケーションユーザー権限制限（`www-data`等）
- [ ] セキュリティヘッダー追加（`X-Content-Type-Options`等）
- [ ] 依存関係脆弱性チェック（`pip-audit`）
- [ ] ログに機密情報が含まれていないか確認

### 8.2 定期チェック

- [ ] 依存関係更新（月1回）
  ```bash
  pip list --outdated
  pip install --upgrade redis langchain langgraph
  ```
- [ ] セキュリティパッチ適用（週1回）
  ```bash
  sudo apt update && sudo apt upgrade -y
  ```
- [ ] ログ確認（毎日）
  ```bash
  grep -i error logs/error.log
  ```
- [ ] メトリクス確認（週1回）
  ```bash
  python -c "from metrics import get_summary; print(get_summary())"
  ```

### 8.3 セキュリティツール

```bash
# 1. 脆弱性スキャン
pip install pip-audit
pip-audit

# 2. 静的解析
pip install bandit
bandit -r . -ll

# 3. 依存関係チェック
pip install safety
safety check
```

---

## 9. パフォーマンスチューニング

### 9.1 Redis最適化

```conf
# redis.conf

# メモリ最適化
maxmemory-samples 10  # LRUサンプル数増加（精度向上）

# ネットワーク最適化
tcp-backlog 511
tcp-keepalive 300

# 永続化無効化（キャッシュ専用）
save ""
appendonly no
```

### 9.2 Python最適化

```bash
# pypy使用（5-10倍高速化）
pypy3 -m venv venv-pypy
source venv-pypy/bin/activate
pip install -r requirements.txt
```

### 9.3 ベンチマーク

```bash
# パフォーマンステスト実行
pytest test_performance_phase2.py -v --benchmark-only

# 結果サマリー
# - Redis読み取り: ~5ms
# - 書き込み: ~5ms
# - 並行アクセス: ~29ms
```

---

## 10. バックアップ・復元

### 10.1 Redisバックアップ

```bash
# RDBスナップショット作成
redis-cli SAVE

# RDBファイルコピー
sudo cp /var/lib/redis/dump.rdb /backup/redis-$(date +%Y%m%d).rdb

# 自動バックアップ（cron）
0 2 * * * redis-cli SAVE && cp /var/lib/redis/dump.rdb /backup/redis-$(date +\%Y\%m\%d).rdb
```

### 10.2 アプリケーションデータバックアップ

```bash
# dataディレクトリバックアップ
tar -czf backup-$(date +%Y%m%d).tar.gz data/ logs/ .env

# リモートバックアップ（rsync）
rsync -avz data/ user@backup-server:/backup/llmmultichat3/data/
```

### 10.3 復元

```bash
# Redis復元
sudo systemctl stop redis
sudo cp /backup/redis-20250113.rdb /var/lib/redis/dump.rdb
sudo chown redis:redis /var/lib/redis/dump.rdb
sudo systemctl start redis

# アプリケーションデータ復元
tar -xzf backup-20250113.tar.gz
```

---

## 11. 本番環境チェックリスト

### 11.1 インフラ

- [ ] サーバーセキュリティグループ設定
- [ ] ファイアウォールルール設定
- [ ] バックアップ自動化設定
- [ ] 監視アラート設定

### 11.2 アプリケーション

- [ ] 環境変数設定完了
- [ ] Redis TLS有効化
- [ ] ログローテーション設定
- [ ] systemdサービス登録

### 11.3 テスト

- [ ] 全ユニットテスト成功（75/75）
- [ ] パフォーマンステスト実施
- [ ] セキュリティ監査実施
- [ ] 負荷テスト実施

---

## 12. サポート・連絡先

**プロジェクトURL**: https://github.com/your-org/LlmMultiChat3  
**ドキュメント**: `docks/`ディレクトリ  
**Issue報告**: GitHub Issues  
**緊急連絡**: dev-team@your-org.com

---

**作成日**: 2025-11-13  
**バージョン**: 1.0  
**ステータス**: ✅ レビュー待ち